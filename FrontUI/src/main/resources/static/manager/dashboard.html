<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CueCode | 관리자 대시보드</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg"/>
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css"/>
    <link rel="stylesheet" href="../css/manager/manager.css"/>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div id="dangerousPhraseAlert" style="position: fixed; top: 10px; right: 10px; background-color: #ffcccc; border: 1px solid #ff0000; padding: 10px; border-radius: 5px; z-index: 1000; display: none;">
        <strong>위험 알림!</strong><br>
        환자: <span id="alertPatientName"></span> (<span id="alertPatientId"></span>)<br>
        위험 문구 감지됨!
    </div>
<!--Header start!-->
<header class="header border-4 border-primary border-top position-fixed start-0 top-0 w-100 fixed-header">
    <div class="container">
        <div class="header-wrapper d-flex align-items-center justify-content-between">
            <div class="logo">
                <a href="/index.html" class="logo-white">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
                <a href="/index.html" class="logo-dark">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="btn-group">
                    <button
                            class="btn btn-secondary toggle-menu round-45 p-2 d-flex align-items-center justify-content-center bg-white rounded-circle"
                            type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        <iconify-icon icon="solar:hamburger-menu-line-duotone"
                                      class="menu-icon fs-8 text-dark"></iconify-icon>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-4">
                        <div class="d-flex flex-column gap-6">
                            <div class="hstack justify-content-between border-bottom pb-6">
                                <p class="mb-0 fs-5 text-dark">Menu</p>
                                <button type="button" class="btn-close opacity-75" aria-label="Close"></button>
                            </div>
                            <div class="d-flex flex-column gap-3">
                                <ul class="header-menu list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="header-item">
                                        <a href="/index.html" aria-current="true"
                                           class="header-link active hstack gap-2 fs-7 fw-bold text-dark"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">홈</a>
                                    </li>
                                    <li class="header-item" id="patientMenuItem">
                                        <a href="patient-dashboard.html"
                                           class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="patientMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">환자 대시보드</a>
                                    </li>
                                    <li class="header-item" id="managerMenuItem">
                                        <a href="../manager/dashboard.html"
                                           class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="managerMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">관리자 대시보드</a>
                                    </li>
                                    <li class="header-item" id="myPageMenuItem">
                                        <a href="mypage.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark"
                                           id="myPageMenuLinkAnchor"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">마이 페이지</a>
                                    </li>
                                </ul>
                                <div class="hstack gap-3" id="auth-btn-group">
                                    <a href="sign-in.html"
                                       class="btn btn-outline-light fs-6 bg-white px-3 py-2 text-dark w-50 hstack justify-content-center">로그인</a>
                                    <a href="sign-up.html"
                                       class="btn btn-dark text-white fs-6 bg-dark px-3 py-2 w-50 hstack justify-content-center">회원가입</a>
                                </div>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>
<!--Header end!-->

<main class="flex-grow container mx-auto p-4 p-sm-8">
    <!-- 환자 추가 section start!-->
    <div class="bg-white shadow-lg rounded-3 p-4 p-sm-6 mb-4" id="add-patient-card">
        <div class="d-flex flex-column align-items-start mb-4">
            <div class="d-flex align-items-center gap-3 mb-2">
                <h2 class="fs-7 fw-bold text-dark mb-0">환자 추가</h2>
            </div>
            <p class="text-secondary fs-6 mb-0">
                환자 ID를 입력하여 기존 환자를 조회하거나 새로운 환자를 연결할 수 있습니다.
            </p>
        </div>
        <form id="add-patient-form" novalidate>
            <div class="row g-3 align-items-stretch">
                <div class="col-12 col-lg-8">
                    <div class="input-group input-group-lg add-field-wrapper">
          <span class="input-group-text bg-white border-2">
            <iconify-icon icon="solar:search-linear" class="fs-5 text-secondary"></iconify-icon>
          </span>
                        <input
                                type="text"
                                class="form-control border-2"
                                id="add-patient-id"
                                placeholder="예) patient01"
                                autocomplete="off"
                        />
                        <button class="btn btn-outline-secondary" type="button" id="btn-check">
                            <!--                            <iconify-icon icon="solar:checklist-linear" class="me-1"></iconify-icon>-->
                            조회
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="btn-clear" title="입력 지우기">
                            <iconify-icon icon="solar:close-circle-linear"></iconify-icon>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-lg-4 d-grid">
                    <button id="add-patient-btn" class="btn btn-primary btn-lg w-100" disabled>
    <span class="btn-label">
      <iconify-icon icon="solar:user-plus-linear" class="me-2"></iconify-icon>추가
    </span>
                        <span class="btn-wait d-none">
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      <span class="ms-2">처리 중...</span>
    </span>
                    </button>
                </div>
            </div>
        </form>

        <!-- 조회 결과/미리보기 -->
        <div id="check-result" class="mt-3 p-3 rounded-3 border d-none">
            <div class="d-flex align-items-start gap-3">
                <iconify-icon id="check-icon" icon="solar:shield-check-linear" class="fs-2"></iconify-icon>
                <div class="flex-grow-1">
                    <div id="check-title" class="fw-bold"></div>
                    <div id="check-desc" class="small text-secondary"></div>
                </div>

            </div>
        </div>
    </div>
    <!-- 환자 추가 section End!-->

    <!-- 환자 리스트 section start!-->
    <div class="bg-white shadow-lg rounded-3 p-4 p-sm-6">
        <div class="d-flex align-items-center gap-3 mb-2">
            <h2 class="fs-7 fw-bold text-dark mb-0">환자 목록</h2>
        </div>
        <div id="patient-list" class="table-responsive">
            <table class="patient-table table w-100 border-collapse">
                <thead>
                <tr>
                    <th class="rounded-top-start">환자 ID</th>
                    <th>이름</th>
                    <th class="rounded-top-end">환자 상태</th>
                </tr>
                </thead>
                <tbody id="patient-list-tbody">
                </tbody>
            </table>
        </div>
    </div>
    <!-- 환자 리스트 section End!-->

    <!-- 환자 정보 모달창 section start!-->
    <div id="patient-modal" class="modal-dialog-centered d-none">
        <div class="modal-content-custom hospital-modal">
            <header class="modal-header-hospital">
                <div class="header-icon">
                    <iconify-icon icon="solar:user-bold-duotone"></iconify-icon>
                </div>
                <div class="header-text">
                    <h2 id="modal-patient-name-title">환자 이름</h2>
                    <p id="modal-patient-id-subtitle">ID: P00000</p>
                </div>
                <button id="modal-close-btn" aria-label="Close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"
                         viewBox="0 0 24 24">
                        <path d="M6 6l12 12M6 18L18 6"/>
                    </svg>
                </button>
            </header>
            <main class="modal-body-custom">
                <div class="d-flex flex-column gap-4">
                    <section class="info-section">
                        <h3>
                            <iconify-icon icon="solar:document-text-linear"></iconify-icon>
                            기본 정보
                        </h3>
                        <div class="row g-3">
                            <div class="col-md-6 info-group">
                                <label>이름</label>
                                <p id="modal-patient-name" class="info-text"></p>
                            </div>
                            <div class="col-md-6 info-group">
                                <label>이메일</label>
                                <p id="modal-patient-email" class="info-text"></p>
                            </div>
                            <div class="col-12 info-group">
                                <label>담당 매니저</label>
                                <p id="modal-patient-managers" class="info-text"></p>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h3>
                            <iconify-icon icon="solar:medical-kit-bold-duotone"></iconify-icon>
                            의료 정보
                        </h3>
                        <div class="d-flex flex-column gap-3">
                            <div class="info-group">
                                <label>진료 이력</label>
                                <p id="modal-patient-history" class="info-text"></p>
                                <textarea id="modal-patient-history-input" class="d-none form-control"
                                          rows="3"></textarea>
                            </div>
                            <div class="info-group">
                                <label>복용약</label>
                                <p id="modal-patient-medications" class="info-text"></p>
                                <input id="modal-patient-medications-input" type="text" class="d-none form-control"/>
                            </div>
                            <div class="info-group alert-info-group">
                                <label>알레르기</label>
                                <p id="modal-patient-allergies" class="info-text"></p>
                                <input id="modal-patient-allergies-input" type="text" class="d-none form-control"/>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
            <footer class="modal-footer-custom" id="modal-footer-btns">
                <div class="d-flex w-100 gap-2">
                    <button id="modal-edit-btn" class="btn btn-light fw-bold w-100 py-2">수정하기</button>
                    <button id="modal-delete-btn" class="btn btn-danger fw-bold w-100 py-2">연결 해제</button>
                </div>
            </footer>
            <footer class="modal-footer-custom d-none" id="modal-footer-edit">
                <div class="d-flex w-100 gap-2">
                    <button id="modal-save-btn" class="btn btn-primary fw-bold w-100 py-2">저장</button>
                    <button id="modal-cancel-btn" class="btn btn-secondary fw-bold w-100 py-2">취소</button>
                </div>
            </footer>
        </div>
    </div>
        <!-- 환자 정보 모달창 section End!-->
    
        <!-- 응급 알러트 모달 -->
        <div class="modal fade" id="emergency-alert-modal" tabindex="-1" aria-labelledby="emergencyAlertModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-danger border-4">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="emergencyAlertModalLabel">
                            <iconify-icon icon="solar:alarm-bold-duotone" class="me-2"></iconify-icon>응급 알림
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center fs-5">
                        <p>응급 상황이 발생했습니다!</p>
                        <p><strong>환자 ID:</strong> <span id="alert-patient-id"></span></p>
                        <p><strong>환자 이름:</strong> <span id="alert-patient-name"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="confirm-alert-btn">확인</button>
                    </div>
                </div>
            </div>
        </div>
    
    </main>

<!--footer start!-->
<footer class="footer bg-dark py-5 py-lg-11 py-xl-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-5 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-8 pe-xl-5">
                    <h4 class="mb-0 text-white">이 프로젝트는 <br> 2025 새싹 해커톤
                        <br>공모전 출품작입니다</h4>
                </div>
            </div>
            <div class="col-md-6 col-xl-4 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-2">
                    <a href="https://dacon.io/competitions/official/236624/overview/description" target="_blank" class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:arrow-up-right" class="fs-7 text-primary"></iconify-icon>
                        https://dacon.io
                    </a>
                    <a href="https://buly.kr/Awg81rV" target="_blank"
                       class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:map-pin" class="fs-7 text-primary"></iconify-icon>
                        200ok
                    </a>
                </div>
            </div>
            <div class="col-md-4 col-xl-3 mb-8 mb-xl-0">
                <p class="mb-0 text-white text-opacity-70 text-md-end">© CueCode copyright 2025</p>
            </div>
        </div>
    </div>
    <p class="mb-0 text-white text-opacity-70 text-md-center mt-10">Distributed by <a class="text-white"  target="_blank">Team Ujangsan Spirit</a></p>
</footer>
<!--footer End!-->

<div class="get-template hstack gap-2">
    <button class="btn bg-primary p-2 round-52 rounded-circle hstack justify-content-center flex-shrink-0"
            id="scrollToTopBtn">
        <iconify-icon icon="lucide:arrow-up" class="fs-7 text-dark"></iconify-icon>
    </button>
</div>

<script src="../js/user/index.js"></script>
<script src="../js/config.js"></script>
<script src="../libs/jquery/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/owl.carousel/dist/owl.carousel.min.js"></script>
<script src="../libs/aos-master/dist/aos.js"></script>
<script src="../js/custom.js"></script>
    <script src="../js/manager/manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <script>
        // Global function to process external dangerous phrase detection data
        // This function should be called with an array of alert objects,
        // like the JSON snippet provided by the user.
        window.processDetectedAlerts = function(alertsData) {
            const alertDiv = document.getElementById('dangerousPhraseAlert');
            const alertPatientNameSpan = document.getElementById('alertPatientName');
            const alertPatientIdSpan = document.getElementById('alertPatientId');

            // Determine active dangerous alerts (unconfirmed and matching phrases)
            const dangerAlerts = Array.isArray(alertsData) ? alertsData.filter(a => {
                if (a == null || a.confirmed) return false;
                const p = String(a.phrase ?? '').trim();
                return p.includes('도와주세요') || p.includes('아파요');
            }) : [];

            // Show the top-right alert using the most recent danger alert (if any)
            const activeAlert = dangerAlerts.length ? dangerAlerts[dangerAlerts.length - 1] : null;
            if (activeAlert) {
                alertPatientNameSpan.textContent = activeAlert.userName || '(이름 없음)';
                alertPatientIdSpan.textContent = activeAlert.userId || '(ID 없음)';
                alertDiv.style.display = 'block';

                // Auto-hide after 10s
                setTimeout(() => { alertDiv.style.display = 'none'; }, 10000);
            } else {
                alertDiv.style.display = 'none';
            }

            // Highlight patient rows in the table by data-patient-id
            // Collect IDs from dangerAlerts
            console.log('[DEBUG] processDetectedAlerts called with alerts:', alertsData);
            const dangerIds = dangerAlerts.map(a => String(a.userId).trim());
            console.log('[DEBUG] Danger IDs (unconfirmed):', dangerIds);
            const rows = document.querySelectorAll('#patient-list-tbody tr');
            console.log('[DEBUG] Found', rows.length, 'patient rows in table');
            rows.forEach(row => {
                const dataPid = (row.getAttribute('data-patient-id') || '').trim();
                const tdId = (row.querySelector('td:nth-child(1)')?.textContent || '').trim();
                const tdName = (row.querySelector('td:nth-child(2)')?.textContent || '').trim();

                // Decide match by any reasonable heuristic:
                // - exact data-patient-id match
                // - first cell (id) includes alert id
                // - alert id includes first cell
                // - second cell (name) includes alert.userName
                let matched = false;
                let matchedBy = '';

                for (const aid of dangerIds) {
                    if (!aid) continue;
                    if (dataPid && dataPid === aid) { matched = true; matchedBy = 'data-patient-id exact'; break; }
                    if (tdId && tdId === aid) { matched = true; matchedBy = 'td id exact'; break; }
                    if (tdId && aid.includes(tdId)) { matched = true; matchedBy = 'aid includes tdId'; break; }
                    if (aid && tdId && tdId.includes(aid)) { matched = true; matchedBy = 'tdId includes aid'; break; }
                    // match by name if available
                    const correspondingAlert = dangerAlerts.find(a => String(a.userId).trim() === aid);
                    const alertName = correspondingAlert ? String(correspondingAlert.userName || '').trim() : '';
                    if (alertName && tdName && tdName.includes(alertName)) { matched = true; matchedBy = 'name includes'; break; }
                }

                console.log(`[DEBUG] row pidAttr=${dataPid} tdId=${tdId} tdName=${tdName} => matched=${matched} (${matchedBy})`);
                if (matched) {
                    row.classList.add('alert-red-row');
                    row.querySelectorAll('td').forEach(td => {
                        td.style.backgroundColor = '#ffebeb';
                        td.style.color = '#b20000';
                    });
                    console.log('[DEBUG] Applied alert-red-row styling to row', dataPid || tdId);
                } else {
                    row.classList.remove('alert-red-row');
                    row.querySelectorAll('td').forEach(td => { td.style.backgroundColor = ''; td.style.color = ''; });
                }
            });
         };

         // Example of how to use window.processDetectedAlerts:
         // You would call this function whenever your frontend receives
         // new dangerous phrase detection data, for example, from a WebSocket,
         // an API call, or other real-time update mechanisms.

     </script>
 </body>
 </html>
