<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CueCode | 로그인</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg" />
    <!-- 부트스트랩 CSS -->
    <link rel="stylesheet" href="../css/bootstrap.css" />
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <!-- JWT 디코딩을 위한 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="../css/user/sign-in.css">
    <style>
        .btn-cuecode {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            color: #fff;
            font-weight: 600;
            border: none;
            border-radius: 2rem;
            box-shadow: 0 2px 8px rgba(59,130,246,0.12);
            padding: 0.5rem 2rem;
            font-size: 1.05rem;
            transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .btn-cuecode:hover, .btn-cuecode:focus {
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
            box-shadow: 0 4px 16px rgba(59,130,246,0.18);
            transform: translateY(-2px) scale(1.04);
            color: #fff;
        }
        .btn-cuecode:active {
            background: #2563eb;
            color: #fff;
        }
        .btn-cuecode[disabled] {
            background: #e5e7eb;
            color: #94a3b8;
            box-shadow: none;
            cursor: not-allowed;
        }
        .cuecode-save-btn {
          margin-top: 12px;
          padding: 0.7rem 2.5rem;
          font-size: 1.15rem;
          border-radius: 2rem;
          font-weight: 600;
          box-shadow: 0 2px 8px rgba(59,130,246,0.10);
          background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
          color: #fff;
          border: none;
          transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .cuecode-save-btn:hover, .cuecode-save-btn:focus {
          background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
          box-shadow: 0 4px 16px rgba(59,130,246,0.18);
          transform: translateY(-2px) scale(1.04);
          color: #fff;
        }
        .cuecode-save-btn:active {
          background: #2563eb;
          color: #fff;
        }
        .cuecode-save-btn[disabled] {
          background: #e5e7eb;
          color: #94a3b8;
          box-shadow: none;
          cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="login-container">
                <div class="row g-0">
                    <!-- 좌측 Hero 섹션 -->
                    <div class="col-md-6 hero-section d-flex flex-column justify-content-center p-5 position-relative">
                        <a href="/user/index.html" class="home-icon-link position-absolute" style="top:24px;left:24px;z-index:10;">
                            <iconify-icon icon="mingcute:home-3-fill" width="32" height="32" style="color: #e9ecef"></iconify-icon>
                        </a>
                        <img src="/images/logos/logo-white-clean.svg" alt="CueCode Logo" class="img-fluid mb-4" style="max-width:350px;">
                        <h3 class="mb-3 display-6 fw-bold">Subtle Gestures, Deep Connections</h3>
                        <p class="fs-5">CueCode와 함께라면<br>당신의 표현이 언제나 닿을 수 있어요.</p>
                    </div>
                    <!-- 우측 본인 확인 및 정보 카드 -->
                    <div class="col-md-6 d-flex flex-column justify-content-center p-5">
                        <div class="w-100" id="info-area">
                            <h1 class="text-center display-6 fw-bold mb-4">나의 정보 관리</h1>
                            <div id="my-info-card" class="mt-5">
<!--                                <h2 class="text-center fw-bold mb-4">나의 정보</h2>-->
                                <div class="card p-4 shadow-sm">
                                    <div class="mb-3 d-flex flex-row align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold" style="min-width:60px;">이름</span>
                                            <span id="info-name" class="ms-3"></span>
                                        </div>
                                        <button class="btn btn-cuecode btn-sm" id="changeNameBtn">변경하기</button>
                                    </div>
                                    <div class="mb-3 d-flex flex-row align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold" style="min-width:60px;">아이디</span>
                                            <span id="info-id" class="ms-3"></span>
                                        </div>
                                        <button class="btn btn-cuecode btn-sm" id="changeIdBtn">변경하기</button>
                                    </div>
                                    <div class="mb-3 d-flex flex-row align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold" style="min-width:60px;">이메일</span>
                                            <span id="info-email" class="ms-3"></span>
                                        </div>
                                        <button class="btn btn-cuecode btn-sm" id="changeEmailBtn">변경하기</button>
                                    </div>
                                    <div class="mb-3 d-flex flex-row align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold" style="min-width:60px;">비밀번호</span>
                                        </div>
                                        <button class="btn btn-cuecode btn-sm" id="changePwBtn">변경하기</button>
                                    </div>
                                    <div class="mb-3 d-flex flex-row align-items-center justify-content-between" id="detection-area-row" style="display:none;">
                                      <div class="d-flex align-items-center">
                                        <span class="fw-bold" style="min-width:60px;">감지 범위</span>
                                        <span id="detection-area-value" class="ms-3"></span>
                                      </div>
                                      <button class="btn btn-cuecode btn-sm" id="changeDetectionAreaBtn">변경하기</button>
                                    </div>
                                    <div class="mb-3 text-center">
                                      <button class="btn btn-primary btn-lg py-3 login-btn" id="saveDetectionAreaBtnMain">저장하기</button>
                                    </div>
                                </div>
                            </div>
                            <!-- 이름 변경 모달 -->
                            <div class="modal fade" id="changeNameModal" tabindex="-1" aria-labelledby="changeNameModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="changeNameModalLabel">이름 변경</h5>
                                  </div>
                                  <div class="modal-body">
                                    <input type="text" class="form-control" id="newNameInput" placeholder="새 이름 입력" />
                                    <div class="form-text text-danger mt-2" id="changeNameMsg"></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-cuecode" id="saveNameBtn">저장</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <!-- 아이디 변경 모달 -->
                            <div class="modal fade" id="changeIdModal" tabindex="-1" aria-labelledby="changeIdModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="changeIdModalLabel">아이디 변경</h5>
                                  </div>
                                  <div class="modal-body">
                                    <input type="text" class="form-control" id="newIdInput" placeholder="새 아이디 입력" />
                                    <div class="form-text text-danger mt-2" id="changeIdMsg"></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-cuecode" id="saveIdBtn">저장</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <!-- 이메일 변경 모달 -->
                            <div class="modal fade" id="changeEmailModal" tabindex="-1" aria-labelledby="changeEmailModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="changeEmailModalLabel">이메일 변경</h5>
                                  </div>
                                  <div class="modal-body">
                                    <div class="d-flex align-items-center mb-2" style="gap: 10px;">
                                      <input type="email" class="form-control" id="newEmailInput" placeholder="새 이메일 입력" style="flex:1; min-width:180px; height:40px; border-radius:8px;" />
                                      <button type="button" class="btn btn-cuecode" id="sendEmailCodeBtn">인증번호 발송</button>
                                    </div>
                                    <input type="text" class="form-control mb-2" id="emailCodeInput" placeholder="인증번호 입력" style="height:40px; border-radius:8px;" />
                                    <div class="form-text text-danger mt-2" id="changeEmailMsg"></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-cuecode" id="saveEmailBtn">저장</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <!-- 비밀번호 변경 모달 -->
                            <div class="modal fade" id="changePwModal" tabindex="-1" aria-labelledby="changePwModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="changePwModalLabel">비밀번호 변경</h5>
                                  </div>
                                  <div class="modal-body">
                                    <input type="password" class="form-control mb-2" id="currentPwInput" placeholder="현재 비밀번호 입력" />
                                    <input type="password" class="form-control mb-2" id="newPwInput" placeholder="새 비밀번호 입력" />
                                    <input type="password" class="form-control mb-2" id="confirmPwInput" placeholder="새 비밀번호 확인" />
                                    <div class="form-text text-danger mt-2" id="changePwMsg"></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-cuecode" id="savePwBtn">저장</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <!-- 감지 범위 변경 모달 -->
                            <div class="modal fade" id="changeDetectionAreaModal" tabindex="-1" aria-labelledby="changeDetectionAreaModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="changeDetectionAreaModalLabel">감지 범위 변경</h5>
                                  </div>
                                  <div class="modal-body">
                                    <div class="d-flex flex-column gap-2">
                                      <label><input type="radio" name="detectionAreaType" value="hand" id="detectHand"> 손</label>
                                      <label><input type="radio" name="detectionAreaType" value="face" id="detectFace"> 얼굴</label>
                                      <label><input type="radio" name="detectionAreaType" value="both" id="detectBoth"> 손과 얼굴</label>
                                    </div>
                                    <div class="form-text text-danger mt-2" id="changeDetectionAreaMsg"></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-cuecode" id="saveDetectionAreaBtnModal">저장</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <ul class="login-text-menu mt-5">
                                <li><a href="#" id="withdrawalBtn">회원탈퇴</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 마스킹 함수
function maskName(name) {
    if (!name) return '';
    return name[0] + '*'.repeat(Math.max(0, name.length - 1));
}
function maskId(id) {
    if (!id) return '';
    if (id.length <= 4) return id[0] + '***' + id[id.length-1];
    return id.slice(0,2) + '***' + id.slice(-2);
}
function maskEmail(email) {
    if (!email) return '이메일 정보 없음';
    const [local, domain] = email.split('@');
    if (!local || !domain) return email;
    return local.slice(0,2) + '***@' + domain;
}
document.addEventListener('DOMContentLoaded', function() {
    let userId = '';
    let currentPatientId = '';
    const token = document.cookie.split('; ').find(row => row.startsWith('jwtAccessToken='));
    if (token) {
        try {
            const decoded = jwt_decode(token.split('=')[1]);
            userId = decoded.sub || decoded.userId || '';
        } catch (e) {
            userId = '';
        }
    }
    console.log('[프론트] userId:', userId); // userId 추출 직후 로그 추가
    // 사용자 정보 API로 정보 표시
    if (userId) {
        fetch('http://localhost:13000/user/info?userId=' + encodeURIComponent(userId), {
            method: 'GET',
            credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
            console.log('[프론트] user info 응답:', data); // user info 응답 로그 추가
            document.getElementById('info-name').textContent = maskName(data.name || data.userName || '');
            document.getElementById('info-id').textContent = maskId(data.id || data.userId || userId);
            document.getElementById('info-email').textContent = maskEmail(data.email || '');
            // 감지 범위 표시: 환자 회원이면 별도 API 호출
            const detectionAreaRow = document.getElementById('detection-area-row');
            if (data.userType === 'patient') {
                console.log('[프론트] 감지 범위 조회 요청 body:', { patientId: userId });
                fetch('http://localhost:13000/patient/detection-area/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patientId: userId })
                })
                .then(res => res.json())
                .then(area => {
                    console.log('[프론트] 감지 범위 조회 응답:', area);
                    if (area.result === 1) {
                        const areaText = area.detectionArea === 'hand' ? '손' : area.detectionArea === 'face' ? '얼굴' : area.detectionArea === 'both' ? '손과 얼굴' : '설정 안됨';
                        document.getElementById('detection-area-value').textContent = areaText;
                        detectionAreaRow.style.display = 'flex';
                    } else {
                        document.getElementById('detection-area-value').textContent = '설정 안됨';
                        detectionAreaRow.style.display = 'flex';
                    }
                })
                .catch((err) => {
                    console.error('[프론트] 감지 범위 조회 fetch 에러:', err);
                    document.getElementById('detection-area-value').textContent = '조회 오류';
                    detectionAreaRow.style.display = 'flex';
                });
            } else {
                detectionAreaRow.style.display = 'none';
            }
        });
    }
    // 이름 변경 버튼
    document.getElementById('changeNameBtn').onclick = function() {
        document.getElementById('changeNameMsg').textContent = '';
        document.getElementById('newNameInput').value = '';
        new bootstrap.Modal(document.getElementById('changeNameModal')).show();
    };
    document.getElementById('saveNameBtn').onclick = async function() {
        const newName = document.getElementById('newNameInput').value.trim();
        if (!newName) {
            document.getElementById('changeNameMsg').textContent = '새 이름을 입력하세요.';
            return;
        }
        // 이름 변경 API 호출
        const res = await fetch('http://localhost:13000/user/update-name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, newName }),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok && data.result === 1) {
            document.getElementById('info-name').textContent = maskName(newName);
            Swal.fire({ icon: 'success', text: '이름이 변경되었습니다.', timer: 1200, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('changeNameModal')).hide();
        } else {
            document.getElementById('changeNameMsg').textContent = data.msg || '이름 변경 실패';
        }
    };
    // 아이디 변경 버튼
    document.getElementById('changeIdBtn').onclick = function() {
        document.getElementById('changeIdMsg').textContent = '';
        document.getElementById('newIdInput').value = '';
        new bootstrap.Modal(document.getElementById('changeIdModal')).show();
    };
    document.getElementById('saveIdBtn').onclick = async function() {
        const newId = document.getElementById('newIdInput').value.trim();
        if (!newId) {
            document.getElementById('changeIdMsg').textContent = '새 아이디를 입력하세요.';
            return;
        }
        // 아이디 변경 API 호출
        const res = await fetch('http://localhost:13000/user/update-id', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, newId }),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok && data.result === 1) {
            document.getElementById('info-id').textContent = maskId(newId);
            Swal.fire({ icon: 'success', text: '아이디가 변경되었습니다.', timer: 1200, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('changeIdModal')).hide();
            userId = newId;
        } else {
            document.getElementById('changeIdMsg').textContent = data.msg || '아이디 변경 실패';
        }
    };
    // 이메일 변경 버튼
    document.getElementById('changeEmailBtn').onclick = function() {
        document.getElementById('changeEmailMsg').textContent = '';
        document.getElementById('newEmailInput').value = '';
        document.getElementById('emailCodeInput').value = '';
        new bootstrap.Modal(document.getElementById('changeEmailModal')).show();
    };
    let emailChangeVerified = false, emailChangeCountdown = null, emailChangeRemaining = 0;
function formatTime(sec){ const m = Math.floor(sec/60).toString().padStart(2,'0'); const s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
function startEmailChangeCountdown(seconds){
  emailChangeRemaining = seconds;
  document.getElementById('changeEmailMsg').textContent = `인증번호 입력 (${formatTime(emailChangeRemaining)})`;
  clearInterval(emailChangeCountdown);
  emailChangeCountdown = setInterval(()=>{
    emailChangeRemaining--;
    document.getElementById('changeEmailMsg').textContent = `인증번호 입력 (${formatTime(Math.max(emailChangeRemaining,0))})`;
    if(emailChangeRemaining<=0){
      clearInterval(emailChangeCountdown);
      document.getElementById('changeEmailMsg').textContent = '인증 시간이 만료되었습니다.';
      document.getElementById('sendEmailCodeBtn').disabled = false;
      document.getElementById('sendEmailCodeBtn').textContent = '인증번호 재발송';
    }
  },1000);
}
    // 이메일 인증번호 발송
    document.getElementById('sendEmailCodeBtn').onclick = function() {
      const email = document.getElementById('newEmailInput').value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('changeEmailMsg').textContent = '올바른 이메일 주소를 입력하세요.';
        return;
      }
      fetch('http://localhost:13000/reg/sendMail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
      })
        .then(res => res.json())
        .then(data => {
          if (data.result === 1) {
            startEmailChangeCountdown(180);
            document.getElementById('emailCodeInput').value = '';
            document.getElementById('emailCodeInput').focus();
            document.getElementById('sendEmailCodeBtn').textContent = '발송 완료';
            document.getElementById('sendEmailCodeBtn').disabled = true;
            Swal.fire({ icon: 'success', text: '인증메일이 발송되었습니다. 메일을 확인하세요.' });
          } else {
            Swal.fire({ icon: 'error', text: '메일 발송 실패: ' + data.msg });
          }
        })
        .catch(() => {
          Swal.fire({ icon: 'error', text: '메일 발송 요청 실패' });
        });
    };
    document.getElementById('emailCodeInput').addEventListener('input', function() {
      document.getElementById('changeEmailMsg').textContent = '';
    });
    document.getElementById('emailCodeInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        verifyChangeEmailCode();
      }
    });
    function verifyChangeEmailCode() {
      const email = document.getElementById('newEmailInput').value.trim();
      const authCode = document.getElementById('emailCodeInput').value.trim();
      fetch('http://localhost:13000/reg/verifyEmailAuth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, authCode: authCode })
      })
        .then(res => res.json())
        .then(data => {
          if (data.result === 1) {
            clearInterval(emailChangeCountdown);
            emailChangeVerified = true;
            document.getElementById('changeEmailMsg').textContent = '이메일 인증이 완료되었습니다.';
            document.getElementById('sendEmailCodeBtn').disabled = true;
            document.getElementById('sendEmailCodeBtn').textContent = '인증 완료';
            // 인증 성공 시 모달 자동 닫기
            setTimeout(function() {
              bootstrap.Modal.getInstance(document.getElementById('changeEmailModal')).hide();
            }, 700);
          } else {
            emailChangeVerified = false;
            document.getElementById('changeEmailMsg').textContent = data.msg || '인증번호가 일치하지 않습니다.';
          }
        })
        .catch(() => {
          emailChangeVerified = false;
          document.getElementById('changeEmailMsg').textContent = '서버 인증 요청 실패. 다시 시도해주세요.';
        });
    }
    document.getElementById('emailCodeInput').addEventListener('blur', verifyChangeEmailCode);
    // 이메일 변경 저장 시 인증 완료 여부 체크
    const originalSaveEmailBtn = document.getElementById('saveEmailBtn').onclick;
    document.getElementById('saveEmailBtn').onclick = function() {
      if (!emailChangeVerified) {
        document.getElementById('changeEmailMsg').textContent = '이메일 인증을 완료하세요.';
        return;
      }
      if (typeof originalSaveEmailBtn === 'function') originalSaveEmailBtn();
    };
    // 비밀번호 변경 버튼
    document.getElementById('changePwBtn').onclick = function() {
        document.getElementById('changePwMsg').textContent = '';
        document.getElementById('currentPwInput').value = '';
        document.getElementById('newPwInput').value = '';
        document.getElementById('confirmPwInput').value = '';
        new bootstrap.Modal(document.getElementById('changePwModal')).show();
    };
    document.getElementById('savePwBtn').onclick = async function() {
        const currentPw = document.getElementById('currentPwInput').value.trim();
        const newPw = document.getElementById('newPwInput').value.trim();
        const confirmPw = document.getElementById('confirmPwInput').value.trim();
        if (!currentPw || !newPw || !confirmPw) {
            document.getElementById('changePwMsg').textContent = '모든 항목을 입력하세요.';
            return;
        }
        if (newPw !== confirmPw) {
            document.getElementById('changePwMsg').textContent = '새 비밀번호가 일치하지 않습니다.';
            return;
        }
        // 비밀번호 변경 API 호출
        const res = await fetch('http://localhost:13000/user/update-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, currentPassword: currentPw, newPassword: newPw }),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok && data.result === 1) {
            Swal.fire({ icon: 'success', text: '비밀번호가 변경되었습니다.', timer: 1200, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('changePwModal')).hide();
        } else {
            document.getElementById('changePwMsg').textContent = data.msg || '비밀번호 변경 실패';
        }
    };
    // 감지 범위 변경 버튼
    document.getElementById('changeDetectionAreaBtn').onclick = function() {
      new bootstrap.Modal(document.getElementById('changeDetectionAreaModal')).show();
    };
    document.getElementById('saveDetectionAreaBtnMain').onclick = function() {
  window.location.href = 'http://localhost:14000/user/index.html';
};
document.getElementById('saveDetectionAreaBtnModal').onclick = async function() {
  if (!userId || userId.trim() === '') {
    document.getElementById('changeDetectionAreaMsg').textContent = '환자 정보가 올바르게 로드되지 않았습니다.';
    console.error('감지 범위 변경 시 userId 값:', userId);
    return;
  }
  const detectionAreaType = document.querySelector('input[name="detectionAreaType"]:checked');
  if (!detectionAreaType) {
    document.getElementById('changeDetectionAreaMsg').textContent = '변경할 감지 범위를 선택하세요.';
    return;
  }
  const newDetectionArea = detectionAreaType.value;
  // 감지 범위 변경 API 호출
  const res = await fetch('http://localhost:13000/patient/detection-area/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ patientId: userId, detectionAreaType: newDetectionArea })
  });
  const data = await res.json();
  if (res.ok && data.result === 1) {
      const areaText = newDetectionArea === 'hand' ? '손' : newDetectionArea === 'face' ? '얼굴' : '손과 얼굴';
      document.getElementById('detection-area-value').textContent = areaText;
      Swal.fire({ icon: 'success', text: '감지 범위가 변경되었습니다.', timer: 1200, showConfirmButton: false });
      bootstrap.Modal.getInstance(document.getElementById('changeDetectionAreaModal')).hide();
  } else {
      document.getElementById('changeDetectionAreaMsg').textContent = data.msg || '감지 범위 변경 실패';
  }
};
    // 모달 닫힘 시 포커스 해제
    document.getElementById('changeDetectionAreaModal').addEventListener('hidden.bs.modal', function() {
        if (document.activeElement && document.activeElement.id === 'detectHand') {
            document.activeElement.blur();
        }
    });
    // JWT 토큰을 쿠키에서 꺼내는 함수 추가
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
    document.getElementById('withdrawalBtn').onclick = function(e) {
        e.preventDefault();
        Swal.fire({
            title: '정말 탈퇴하시겠습니까?',
            text: '탈퇴 후 복구가 불가능합니다.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '네, 탈퇴합니다',
            cancelButtonText: '아니오'
        }).then((result) => {
            if (result.isConfirmed) {
                const token = getCookie('jwtAccessToken');
                fetch('http://localhost:13000/user/withdrawal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    credentials: 'include',
                    body: JSON.stringify({ userId })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.result === 1) {
                        Swal.fire({ icon: 'success', text: '정상적으로 탈퇴되었습니다.', timer: 1500, showConfirmButton: false });
                        setTimeout(function() {
                            window.location.href = '/user/sign-in.html';
                        }, 1500);
                    } else {
                        Swal.fire({ icon: 'error', text: data.msg || '탈퇴에 실패했습니다.' });
                    }
                })
                .catch(() => {
                    Swal.fire({ icon: 'error', text: '서버 오류로 탈퇴에 실패했습니다.' });
                });
            }
        });
    };
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
