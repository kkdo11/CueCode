<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>CueCode | 비밀번호 찾기</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg"/>
    <!-- 부트스트랩 CSS -->
    <link rel="stylesheet" href="../css/bootstrap.css"/>
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css"/>

    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/user/sign-in.css">
    <style>
        body {
            background: radial-gradient(60rem 40rem at 10% -10%, #e9f6ff 0%, transparent 60%), #f6f8fb;
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", Segoe UI, Roboto, Arial, "Noto Sans KR", sans-serif;
            color: #1f2937;
            line-height: 1.55;
            margin: 0;
        }

        .container.signup {
            max-width: 1300px;
            margin: 48px auto;
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(2, 8, 20, .08), 0 8px 24px rgba(2, 8, 20, .06);
            background: #fff;
            overflow: hidden;
        }

        .signup-grid {
            display: grid;
            grid-template-columns:1.05fr 1fr;
            min-height: 620px;
        }

        .signup-hero {
            background: linear-gradient(45deg, #172E6C, #6FC8F8);
            padding: 56px 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #fff;
        }

        .signup-hero h3 {
            font-size: 40px;
            font-weight: 800;
            margin: 0 0 14px;
            line-height: 1.15;
        }

        .signup-hero p {
            max-width: 420px;
            margin: 0;
            font-size: 15px;
            color: rgba(255, 255, 255, .9);
        }

        .signup-body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 620px;
            padding: 40px 48px;
        }

        .rail {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
        }

        .rail > * {
            width: 100%;
        }

        h2 {
            font-size: 26px;
            font-weight: 800;
            margin: 0 0 20px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .progress-bar .step {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            border-bottom: 3px solid #e0e7ef;
            color: #b0b8c1;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all .2s;
        }

        .progress-bar .step.active {
            border-bottom: 3px solid #6FC8F8;
            color: #1976d2;
        }

        .step-section {
            display: none;
            height: 420px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .step-section.active {
            display: flex;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: .35rem;
            font-weight: 600;
            font-size: .92rem;
            color: #6b7280;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            width: 100%;
            align-items: center;
        }

        input[type="text"], input[type="password"], input[type="email"] {
            width: 100%;
            height: 48px;
            font-size: 1rem;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fff;
            box-sizing: border-box;
            transition: border-color .18s ease, box-shadow .18s ease;
        }

        input:focus {
            border-color: #90cff8;
            box-shadow: 0 0 0 .25rem rgba(111, 200, 248, .25);
        }

        .action-btn {
            height: 48px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid #dfe7f1;
            background: #eef6ff;
            color: #0f2f50;
            font-weight: 700;
            cursor: pointer;
            transition: all .18s ease;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #dff0ff;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn {
            width: 100%;
            padding: 14px 18px;
            border: 0;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            background: #6FC8F8;
            color: #fff;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease, transform .12s ease;
        }

        .submit-btn:hover {
            background: #5bbcf0;
            transform: translateY(-1px);
            box-shadow: 0 14px 20px rgba(111, 200, 248, .35);
        }

        .msg {
            margin-top: 10px;
            color: #d32f2f;
            font-weight: 600;
            min-height: 22px;
            text-align: center;
        }

        .subtext, .err, .ok {
            min-height: 22px;
            display: block;
        }

        .subtext {
            color: #6b7280;
            font-size: .88rem;
        }

        .ok {
            color: #16a34a;
        }

        .err {
            color: #ef4444;
        }

        .step-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            gap: 24px;
        }

        .next-btn, .prev-btn {
            background: linear-gradient(90deg, #6FC8F8 0%, #1976d2 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(111, 200, 248, .18);
            transition: background .2s, box-shadow .2s, transform .12s;
        }

        .next-btn:hover, .prev-btn:hover {
            background: linear-gradient(90deg, #1976d2 0%, #6FC8F8 100%);
            box-shadow: 0 8px 20px rgba(111, 200, 248, .28);
            transform: translateY(-2px);
        }

        @media (max-width: 991.98px) {
            .signup-grid {
                grid-template-columns:1fr;
            }

            .signup-hero {
                min-height: 280px;
            }

            .signup-body {
                padding: 28px 32px 36px;
            }

            .rail {
                max-width: 680px;
            }
        }

        @media (max-width: 575.98px) {
            .signup-hero h3 {
                font-size: 32px;
            }

            .signup-body {
                padding: 24px 20px 32px;
            }

            .rail {
                max-width: 100%;
            }
        }

        .login-text-menu {
            width: 100%;
            margin: 36px 0 0 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            list-style: none;
            color: #8a8a8a;
            font-size: 1.08rem;
            font-weight: 500;
        }

        .login-text-menu li {
            display: flex;
            align-items: center;
        }

        .login-text-menu li:not(:last-child)::after {
            content: '|';
            display: inline-block;
            margin: 0 12px;
            color: #bdbdbd;
            font-size: 1.08em;
            font-weight: 400;
            vertical-align: middle;
        }

        .login-text-menu a {
            color: #8a8a8a;
            text-decoration: none;
            transition: color .18s;
        }

        .login-text-menu a:hover {
            color: #1976d2;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="login-container">
                <div class="row g-0">
                    <!-- 좌측 Hero 섹션 -->
                    <div class="col-md-6 hero-section d-flex flex-column justify-content-center p-5 position-relative">
                        <a href="/user/index.html" class="home-icon-link position-absolute"
                           style="top:24px;left:24px;z-index:10;">
                            <iconify-icon icon="mingcute:home-3-fill" width="32" height="32"
                                          style="color: #e9ecef"></iconify-icon>
                        </a>
                        <img src="/images/logos/logo-white-clean.svg" alt="CueCode Logo" class="img-fluid mb-4"
                             style="max-width:350px;">
                        <h3 class="mb-3 display-6 fw-bold">Subtle Gestures, Deep Connections</h3>
                        <p class="fs-5">CueCode와 함께라면<br>당신의 표현이 언제나 닿을 수 있어요.</p>
                    </div>
                    <!-- 우측 -->
                    <div class="col-md-6 d-flex flex-column justify-content-center p-5">
                        <div class="w-100">
                            <h1 class="text-center display-6 fw-bold mb-5">비밀번호 찾기</h1>
                            <form id="findPwForm">
                                <div class="form-group">
                                    <label for="user_id">아이디</label>
                                    <input type="text" id="user_id" name="user_id" placeholder="가입 시 사용한 아이디"
                                           autocomplete="username" required/>
                                </div>
                                <div class="form-group">
                                    <label for="email">이메일</label>
                                    <div class="input-row">
                                        <input type="email" id="email" name="email" placeholder="가입 시 사용한 이메일"
                                               autocomplete="email" required/>
                                        <button type="button" class="action-btn" id="sendCodeBtn">인증번호 발송</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="email_code">인증번호</label>
                                    <div class="input-row">
                                        <input type="text" id="email_code" placeholder="인증번호 6자리" inputmode="numeric"
                                               autocomplete="one-time-code"/>
                                        <button type="button" class="action-btn" id="verifyCodeBtn">확인</button>
                                    </div>
                                    <div class="subtext">남은 시간 <span id="countdown">03:00</span></div>
                                    <div class="subtext" id="emailVerifyMsg"></div>
                                </div>
                                <div class="form-group">
                                    <label for="new_password">새 비밀번호</label>
                                    <input type="password" id="new_password" name="new_password"
                                           placeholder="영문·숫자·특수문자 조합 8~20자" autocomplete="new-password" required/>
                                    <div class="subtext" id="pwValidMsg"></div>
                                </div>
                                <div class="form-group">
                                    <label for="new_password2">비밀번호 재입력</label>
                                    <input type="password" id="new_password2" name="new_password2"
                                           placeholder="비밀번호를 다시 입력하세요" autocomplete="new-password" required/>
                                    <div class="subtext err" id="pwCheckMsg"></div>
                                </div>
                                <button type="submit" class="submit-btn">비밀번호 변경</button>
                            </form>
                            <div class="msg" id="msg"></div>
                            <ul class="login-text-menu">
                                <li><a href="/user/sign-in.html">로그인</a></li>
                                <li><a href="/user/sign-up.html">회원가입</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // 단계 관련 변수 및 함수 제거
    let emailVerified = false;
    let countdownTimer = null, remaining = 0;
    // 인증번호 발송
    const emailInput = document.getElementById('email');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const emailCodeInput = document.getElementById('email_code');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const emailVerifyMsg = document.getElementById('emailVerifyMsg');

    function formatTime(sec) {
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = (sec % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function startCountdown(seconds) {
        remaining = seconds;
        document.getElementById('countdown').textContent = formatTime(remaining);
        clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
            remaining--;
            document.getElementById('countdown').textContent = formatTime(Math.max(remaining, 0));
            if (remaining <= 0) {
                clearInterval(countdownTimer);
                emailVerifyMsg.textContent = '인증 시간이 만료되었습니다.';
                verifyCodeBtn.disabled = true;
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = '인증번호 재발송';
            }
        }, 1000);
    }

    sendCodeBtn.onclick = function () {
        const email = emailInput.value.trim();
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            Swal.fire({icon: 'warning', text: '올바른 이메일 주소를 입력하세요.'});
            return;
        }
        fetch('http://localhost:13000/reg/sendMail', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        })
            .then(res => res.json())
            .then(data => {
                if (data.result === 1) {
                    startCountdown(180);
                    emailCodeInput.value = '';
                    emailCodeInput.focus();
                    sendCodeBtn.textContent = '발송 완료';
                    verifyCodeBtn.disabled = false;
                    Swal.fire({icon: 'success', text: '인증메일이 발송되었습니다. 메일을 확인하세요.'});
                } else {
                    Swal.fire({icon: 'error', text: '메일 발송 실패: ' + (data.msg || '서버 오류')});
                }
            })
            .catch(() => {
                Swal.fire({icon: 'error', text: '메일 발송 요청 실패'});
            });
    };
    // 인증번호 검증
    verifyCodeBtn.onclick = function () {
        const email = emailInput.value.trim();
        const authCode = emailCodeInput.value.trim();
        fetch('http://localhost:13000/reg/verifyEmailAuth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, authCode: authCode})
        })
            .then(res => res.json())
            .then(data => {
                if (data.result === 1) {
                    clearInterval(countdownTimer);
                    emailVerified = true;
                    emailVerifyMsg.textContent = '이메일 인증이 완료되었습니다.';
                    verifyCodeBtn.disabled = true;
                    sendCodeBtn.disabled = true;
                    sendCodeBtn.textContent = '인증 완료';
                    Swal.fire({icon: 'success', text: '이메일 인증이 완료되었습니다.'});
                } else {
                    emailVerified = false;
                    emailVerifyMsg.textContent = data.msg || '인증번호가 일치하지 않습니다.';
                    Swal.fire({icon: 'error', text: data.msg || '인증번호가 일치하지 않습니다.'});
                }
            })
            .catch((err) => {
                console.error('이메일 인증 요청 오류:', err);
                emailVerified = false;
                emailVerifyMsg.textContent = '서버 인증 요청 실패. 다시 시도해주세요.';
                Swal.fire({icon: 'error', text: '서버 인증 요청 실패. 다시 시도해주세요.'});
            });
    };
    // 비밀번호 유효성 검사
    const pwInput = document.getElementById('new_password');
    const pw2Input = document.getElementById('new_password2');
    const pwValidMsg = document.getElementById('pwValidMsg');
    const pwCheckMsg = document.getElementById('pwCheckMsg');

    function validatePassword(pw) {
        const lengthValid = pw.length >= 8 && pw.length <= 20;
        const engValid = /[a-zA-Z]/.test(pw);
        const numValid = /[0-9]/.test(pw);
        const specialValid = /[!@#$%^&*(),.?":{}|<>\[\]\\/~`_+=;'\-]/.test(pw);
        return {
            lengthValid,
            engValid,
            numValid,
            specialValid,
            all: lengthValid && engValid && numValid && specialValid
        };
    }

    pwInput.addEventListener('input', function () {
        const pw = pwInput.value;
        const v = validatePassword(pw);
        if (!pw) {
            pwValidMsg.textContent = '';
            pwValidMsg.className = 'subtext';
            return;
        }
        if (v.all) {
            pwValidMsg.textContent = '사용 가능한 비밀번호입니다.';
            pwValidMsg.className = 'subtext ok';
        } else {
            let msg = '비밀번호는 8~20자, 영문, 숫자, 특수문자를 모두 포함해야 합니다.';
            pwValidMsg.textContent = msg;
            pwValidMsg.className = 'subtext err';
        }
    });
    pw2Input.addEventListener('input', function () {
        checkPwMatch();
    });

    function checkPwMatch() {
        const pw = pwInput.value;
        const pw2 = pw2Input.value;
        const v = validatePassword(pw);
        if (!pw2) {
            pwCheckMsg.textContent = '';
            return true;
        }
        if (!v.all) {
            pwCheckMsg.textContent = '비밀번호 조건을 먼저 만족시켜주세요.';
            pwCheckMsg.className = 'subtext err';
            return false;
        }
        if (pw !== pw2) {
            pwCheckMsg.textContent = '비밀번호가 일치하지 않습니다.';
            pwCheckMsg.className = 'subtext err';
            return false;
        } else {
            pwCheckMsg.textContent = '비밀번호가 일치합니다.';
            pwCheckMsg.className = 'subtext ok';
            return true;
        }
    }

    // 폼 제출
    document.getElementById('findPwForm').onsubmit = function (e) {
        e.preventDefault();
        if (!checkPwMatch()) {
            pw2Input.focus();
            return;
        }
        if (!emailVerified) {
            Swal.fire({icon: 'warning', text: '이메일 인증을 완료하세요.'});
            return;
        }
        const user_id = document.getElementById('user_id').value;
        const email = document.getElementById('email').value;
        const new_password = pwInput.value;
        fetch('http://localhost:13000/reg/find/resetPassword', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id, email, new_password})
        })
            .then(res => res.json())
            .then(data => {
                if (data.result === 1) {
                    Swal.fire({icon: 'success', text: '비밀번호가 성공적으로 변경되었습니다. 로그인 페이지로 이동합니다.'});
                    setTimeout(function () {
                        window.location.href = '/user/sign-in.html';
                    }, 1200);
                } else {
                    Swal.fire({icon: 'error', text: data.msg || '비밀번호 변경 실패'});
                }
            })
            .catch(() => {
                Swal.fire({icon: 'error', text: '비밀번호 변경 요청 실패'});
            });
    };
</script>
</body>
</html>
