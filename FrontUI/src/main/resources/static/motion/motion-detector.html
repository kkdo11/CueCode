<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CueCode | ì‹¤ì‹œê°„ ë™ì‘ ì¸ì‹</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg" />
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <link rel="stylesheet" href="../css/patient/patient.css" />
    <style>
        /* ======================================================= */
        /* UIverse í† ê¸€ ìŠ¤ìœ„ì¹˜ CSS (Start) */
        /* ======================================================= */
        .checkbox-wrapper-5 .check {
            --size: 40px;
            position: relative;
            background: linear-gradient(90deg, #19bb85, #9adac4);
            line-height: 0;
            perspective: 400px;
            font-size: var(--size);
        }

        .checkbox-wrapper-5 .check input[type="checkbox"],
        .checkbox-wrapper-5 .check label,
        .checkbox-wrapper-5 .check label::before,
        .checkbox-wrapper-5 .check label::after,
        .checkbox-wrapper-5 .check {
            appearance: none;
            display: inline-block;
            border-radius: var(--size);
            border: 0;
            transition: .35s ease-in-out;
            box-sizing: border-box;
            cursor: pointer;
        }

        .checkbox-wrapper-5 .check label {
            width: calc(2.2 * var(--size));
            height: var(--size);
            background: #d7d7d7;
            overflow: hidden;
        }

        .checkbox-wrapper-5 .check input[type="checkbox"] {
            position: absolute;
            z-index: 1;
            width: calc(.8 * var(--size));
            height: calc(.8 * var(--size));
            top: calc(.1 * var(--size));
            left: calc(.1 * var(--size));
            background: linear-gradient(45deg, #dedede, #ffffff);
            box-shadow: 0 6px 7px rgba(0,0,0,0.3);
            outline: none;
            margin: 0;
        }

        .checkbox-wrapper-5 .check input[type="checkbox"]:checked {
            left: calc(1.3 * var(--size));
        }

        .checkbox-wrapper-5 .check input[type="checkbox"]:checked + label {
            background: transparent;
        }

        .checkbox-wrapper-5 .check label::before,
        .checkbox-wrapper-5 .check label::after {
            content: "Â· Â·";
            position: absolute;
            overflow: hidden;
            left: calc(.15 * var(--size));
            top: calc(.5 * var(--size));
            height: var(--size);
            letter-spacing: calc(-0.04 * var(--size));
            color: #9b9b9b;
            font-family: "Times New Roman", serif;
            z-index: 2;
            font-size: calc(.6 * var(--size));
            border-radius: 0;
            transform-origin: 0 0 calc(-0.5 * var(--size));
            backface-visibility: hidden;
        }

        .checkbox-wrapper-5 .check label::after {
            content: "â—";
            top: calc(.65 * var(--size));
            left: calc(.2 * var(--size));
            height: calc(.1 * var(--size));
            width: calc(.35 * var(--size));
            font-size: calc(.2 * var(--size));
            transform-origin: 0 0 calc(-0.4 * var(--size));
        }

        .checkbox-wrapper-5 .check input[type="checkbox"]:checked + label::before,
        .checkbox-wrapper-5 .check input[type="checkbox"]:checked + label::after {
            left: calc(1.55 * var(--size));
            top: calc(.4 * var(--size));
            line-height: calc(.1 * var(--size));
            transform: rotateY(360deg);
        }

        .checkbox-wrapper-5 .check input[type="checkbox"]:checked + label::after {
            height: calc(.16 * var(--size));
            top: calc(.55 * var(--size));
            left: calc(1.6 * var(--size));
            font-size: calc(.6 * var(--size));
            line-height: 0;
        }
        /* ======================================================= */
        /* UIverse í† ê¸€ ìŠ¤ìœ„ì¹˜ CSS (End) */
        /* ======================================================= */

        /* ğŸ’¡ ë©”ì¸ Flex Containerì— í¬í•¨ë˜ëŠ” ë‘ ì¹´ë“œì˜ ë„ˆë¹„ ì„¤ì • */
        .main-flex-area {
            align-items: stretch !important; /* ìì‹ ìš”ì†Œì˜ ë†’ì´ë¥¼ ê°•ì œë¡œ ë§ì¶¤ (ì˜¤ë¥¸ìª½ column) */
        }
        .camera-control-card {
            /* ì¹´ë©”ë¼ ì¹´ë“œ: ì „ì²´ ê³µê°„ì˜ ì•½ 65% ì°¨ì§€ */
            flex: 0 0 65%;
            max-width: 65%;
            padding: 20px !important;
        }
        .right-side-column {
            /* ì˜¤ë¥¸ìª½ ì—´: ì „ì²´ ê³µê°„ì˜ ì•½ 30% ì°¨ì§€ */
            flex: 0 0 30%;
            max-width: 30%;
            display: flex; /* ë‚´ë¶€ ìš”ì†Œ ìˆ˜ì§ ì •ë ¬ */
            flex-direction: column;
        }
        .range-select-card {
            /* ìƒë‹¨ ì¹´ë“œ */
            height: auto;
        }
        .detected-phrase-card {
            /* í•˜ë‹¨ ì¹´ë“œ: ë‚¨ì€ ê³µê°„ì„ ì±„ì›Œ ì „ì²´ ë†’ì´ë¥¼ ì¹´ë©”ë¼ ì¹´ë“œì™€ ë§ì¶¤ */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* ë‚´ë¶€ ì½˜í…ì¸  ì¤‘ì•™ ì •ë ¬ */
        }

        /* ì¹´ë©”ë¼ ë° ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        #container {
            position: relative;
            display: block;
            width: 100%;
            max-width: 100%;
            height: auto;
            aspect-ratio: 4/3;
            margin-left: auto;
            margin-right: auto;
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }
        #webcam, #output_canvas {
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        #output_canvas { position: absolute; top: 0; left: 0; }

        /* ìƒíƒœ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #status {
            margin-top: 10px;
            color: #555;
            font-weight: 600;
            text-align: center;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        #detectionStatus {
            font-size: 1.1rem;
            min-width: 150px;
            text-align: left;
        }
        .text-running { color: #10B981; }
        .text-stopped { color: #EF4444; }

        /* ì œì–´ í—¤ë” ì»¨í…Œì´ë„ˆ (í† ê¸€ ìŠ¤ìœ„ì¹˜) */
        .control-header {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            justify-content: flex-start !important;
            gap: 20px;
        }

        /* í† ê¸€ ì˜ì—­ */
        .detection-toggle-area-inner {
            display: flex;
            align-items: center;
        }

        /* ğŸ’¡ ê°ì§€ ì˜ì—­ ì„ íƒ ì¹´ë“œ ë²„íŠ¼ ê·¸ë£¹ */
        .detect-btns-select {
            display: flex;
            gap: 12px;
            width: 100%;
            margin-top: 15px; /* ì œëª©ê³¼ì˜ ê°„ê²© */
        }

        /* ğŸ’¡ ê°ì§€ ë²„íŠ¼ ê°œë³„ ìŠ¤íƒ€ì¼: ê°€ë¡œ í­ í™•ì¥ ìœ ì§€ */
        .detect-btns-select .detect-btn {
            padding:8px 14px;
            border-radius:8px;
            border:1px solid #e0e0e0;
            background:#fff;
            color:#333;
            cursor:pointer;
            font-weight:600;
            transition: all 0.2s;
            flex-grow: 1;
            min-width: auto;
        }
        .detect-btns-select .detect-btn.active { background:#6FC8F8; color:#fff; border-color:#6FC8F8; }

        /* ì¸ì‹ëœ ë¬¸ì¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ (flex-grow: 1ë¡œ ë†’ì´ ìë™ í™•ì¥) */
        .detected-phrase-card {
            padding: 30px !important;
            /* ğŸ’¡ ë°°ê²½ìƒ‰ì„ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ìˆ˜ì • */
            background: linear-gradient(135deg, #6FC8F8 0%, #437de4 100%) !important;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 0;
        }
        .detected-phrase-card h5 {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        #detectedPhrase {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            /* í•˜ë‹¨ ì¹´ë“œì—ì„œ ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ flex-grow ë° ì¤‘ì•™ ì •ë ¬ */
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ğŸ’¡ ì‘ì€ í™”ë©´ì—ì„œ ìˆ˜ì§ ë°°ì—´ ë˜ë„ë¡ ì¡°ì • (ëª¨ë°”ì¼ ë°˜ì‘í˜•) */
        @media (max-width: 991px) {
            .camera-control-card, .right-side-column {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 20px;
            }
            .right-side-column {
                margin-top: 0 !important;
            }
            .detected-phrase-card {
                flex-grow: 0;
            }
        }
    </style>
</head>
<body>
<header class="header border-4 border-primary border-top position-fixed start-0 top-0 w-100 fixed-header">
    <div class="container">
        <div class="header-wrapper d-flex align-items-center justify-content-between">
            <div class="logo">
                <a href="/index.html" class="logo-white">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
                <a href="/index.html" class="logo-dark">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="btn-group">
                    <button
                            class="btn btn-secondary toggle-menu round-45 p-2 d-flex align-items-center justify-content-center bg-white rounded-circle"
                            type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        <iconify-icon icon="solar:hamburger-menu-line-duotone" class="menu-icon fs-8 text-dark"></iconify-icon>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-4">
                        <div class="d-flex flex-column gap-6">
                            <div class="hstack justify-content-between border-bottom pb-6">
                                <p class="mb-0 fs-5 text-dark">Menu</p>
                                <button type="button" class="btn-close opacity-75" aria-label="Close"></button>
                            </div>
                            <div class="d-flex flex-column gap-3">
                                <ul class="header-menu list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="header-item">
                                        <a href="index.html" aria-current="true"
                                           class="header-link active hstack gap-2 fs-7 fw-bold text-dark"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™ˆ</a>
                                    </li>
                                    <li class="header-item" id="patientMenuItem">
                                        <a href="/patient/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="patientMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™˜ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="managerMenuItem">
                                        <a href="../manager/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="managerMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="myPageMenuItem">
                                        <a href="../user/mypage.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="myPageMenuLinkAnchor"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ë§ˆì´ í˜ì´ì§€</a>
                                    </li>
                                </ul>
                                <div class="hstack gap-3" id="auth-btn-group">
                                    <a href="sign-in.html"
                                       class="btn btn-outline-light fs-6 bg-white px-3 py-2 text-dark w-50 hstack justify-content-center">ë¡œê·¸ì¸</a>
                                    <a href="sign-up.html"
                                       class="btn btn-dark text-white fs-6 bg-dark px-3 py-2 w-50 hstack justify-content-center">íšŒì›ê°€ì…</a>
                                </div>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container my-5 pt-5">

    <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-10 fade-in-up">

            <div class="d-flex justify-content-center align-items-start gap-4 flex-wrap flex-lg-nowrap main-flex-area">

                <div class="p-3 p-md-5 bg-white rounded shadow camera-control-card">

                    <div class="d-flex align-items-center mb-3 control-header">
                        <div class="d-flex align-items-center detection-toggle-area-inner">
                            <div class="checkbox-wrapper-5">
                                <div class="check">
                                    <input id="detectionToggle" type="checkbox">
                                    <label for="detectionToggle"></label>
                                </div>
                            </div>
                            <span id="detectionStatus" class="ms-3 fw-bold text-stopped">ë™ì‘ ì¸ì‹ ì •ì§€ ì¤‘</span>
                        </div>
                    </div>

                    <div id="container" class="mx-auto">
                        <video id="webcam" autoplay playsinline></video>
                        <canvas id="output_canvas"></canvas>
                    </div>

                    <div id="status" class="mt-3">ìƒíƒœ: ì¹´ë©”ë¼ ì—°ê²° ëŒ€ê¸° ì¤‘</div>
                </div>

                <div class="d-flex flex-column gap-4 right-side-column">

                    <div class="p-4 rounded shadow range-select-card">
                        <h5 class="mb-3 text-center text-dark fw-bold">ì¸ì‹ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h5>
                        <div class="detect-btns-select" id="detectAreaBtns">
                            <button class="detect-btn active" data-value="hands" id="detectHandsBtn">ì†</button>
                            <button class="detect-btn" data-value="face" id="detectFaceBtn">ì–¼êµ´</button>
                            <button class="detect-btn" data-value="eyes" id="detectEyesBtn">ëˆˆ</button>
                        </div>
                    </div>

                    <div class="p-4 bg-primary rounded shadow text-white detected-phrase-card">
                        <h5 class="mb-2 text-center text-white-75">ì¸ì‹ëœ ë¬¸ì¥</h5>
                        <div id="detectedPhrase" class="text-center">ì¸ì‹ ëŒ€ê¸° ì¤‘</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<footer class="footer bg-dark py-5 py-lg-11 py-xl-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-5 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-8 pe-xl-5">
                    <h4 class="mb-0 text-white">ì´ í”„ë¡œì íŠ¸ëŠ” <br> ê°œë°©í˜• í´ë¼ìš°ë“œ í”Œë«í¼(K-PaaS) í™œìš©
                        <br>ê³µëª¨ì „ ì¶œí’ˆì‘ì…ë‹ˆë‹¤</h4>
                </div>
            </div>
            <div class="col-md-6 col-xl-4 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-2">
                    <a href="https://contest.k-paas.org/" target="_blank" class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:arrow-up-right" class="fs-7 text-primary"></iconify-icon>
                        https://contest.k-paas.org/
                    </a>
                    <a href="https://buly.kr/Awg81rV" target="_blank"
                       class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:map-pin" class="fs-7 text-primary"></iconify-icon>
                        ìš°ì¥ì‚° ì‚°ì‹ ë ¹ë“¤
                    </a>
                </div>
            </div>
            <div class="col-md-4 col-xl-3 mb-8 mb-xl-0">
                <p class="mb-0 text-white text-opacity-70 text-md-end">Â© CueCode copyright 2025</p>
            </div>
        </div>
    </div>
    <p class="mb-0 text-white text-opacity-70 text-md-center mt-10">Distributed by <a class="text-white"  target="_blank">Team Ujangsan Spirit</a></p>
</footer>
<div class="get-template hstack gap-2">
    <button class="btn bg-primary p-2 round-52 rounded-circle hstack justify-content-center flex-shrink-0"
            id="scrollToTopBtn">
        <iconify-icon icon="lucide:arrow-up" class="fs-7 text-dark"></iconify-icon>
    </button>
</div>


<script src="../js/user/index.js"></script>
<script src="../js/config.js"></script>
<script src="../libs/jquery/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/owl.carousel/dist/owl.carousel.min.js"></script>
<script src="../libs/aos-master/dist/aos.js"></script>

<script type="module" src="/vendor/mediapipe/js/vision_bundle.js"></script>

<script type="module">
    // MotionLink Demo v0.6ì˜ JavaScript ì½”ë“œ + CueCode í† ê¸€ ìŠ¤ìœ„ì¹˜ ì—°ë™ ë¡œì§

    // Pick the correct backend port!
    // const WEBSOCKET_URL = "ws://localhost:8000/ws/motion";
    // const WEBSOCKET_URL = "ws://localhost:13000/ws/motion";
    const WEBSOCKET_URL = "ws://localhost:15000/ws/motion";

    const SEND_INTERVAL_MS = 100;
    const SEGMENT_MS = 1000; // send "end" every 1s while streaming
    let lastSegmentTs = 0;

    const video = document.getElementById("webcam");
    const canvasElement = document.getElementById("output_canvas");
    const canvasCtx = canvasElement.getContext("2d");

    // MotionLink ë‚´ë¶€ ìƒíƒœ ë©”ì‹œì§€ (Detailed)
    const statusDiv = document.getElementById("status");
    // CueCode UI ìƒë‹¨ ë™ì‘ ì¸ì‹ ìƒíƒœ í…ìŠ¤íŠ¸ (UI/Styling)
    const detectionStatusSpan = document.getElementById("detectionStatus");
    // CueCode í† ê¸€ ìŠ¤ìœ„ì¹˜ ìš”ì†Œ
    const toggle = document.getElementById('detectionToggle');

    const phraseDiv = document.getElementById("detectedPhrase");


    const { FaceLandmarker, HandLandmarker, FilesetResolver, DrawingUtils } =
        await import("/vendor/mediapipe/js/vision_bundle.js");

    let faceLandmarker, handLandmarker, drawingUtils, socket;
    let detectionActive = false;
    let lastVideoTime = -1, lastSendTime = 0;
    let selectedDetectionArea = 'hands'; // 'hands' | 'face' | 'eyes'

    function getNormalizedDetectionArea(raw) {
        if (!raw) return 'hand';
        if (raw === 'hands') return 'hand';
        return 'face'; // treat face/eyes the same for backend
    }

    function sendEnd(area = getNormalizedDetectionArea(selectedDetectionArea)) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "end", detectionArea: area }));
        }
    }

    /**
     * UI ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (í† ê¸€, ìƒë‹¨ í…ìŠ¤íŠ¸, ìƒ‰ìƒ)
     * @param {boolean} isRunning - ì¸ì‹ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
     */
    function setUIStatus(isRunning) {
        toggle.checked = isRunning;
        if (isRunning) {
            detectionStatusSpan.textContent = "ë™ì‘ ì¸ì‹ ì¤‘";
            detectionStatusSpan.classList.remove('text-stopped');
            detectionStatusSpan.classList.add('text-running');
        } else {
            detectionStatusSpan.textContent = "ë™ì‘ ì¸ì‹ ì •ì§€ ì¤‘";
            detectionStatusSpan.classList.remove('text-running');
            detectionStatusSpan.classList.add('text-stopped');
        }
    }

    function setupDetectAreaButtons() {
        const container = document.getElementById('detectAreaBtns');
        if (!container) return;
        container.querySelectorAll('.detect-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const prevArea = getNormalizedDetectionArea(selectedDetectionArea);
                container.querySelectorAll('.detect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedDetectionArea = btn.dataset.value || 'hands';
                const nextArea = getNormalizedDetectionArea(selectedDetectionArea);
                // When switching modes, close the current segment explicitly
                if (detectionActive && prevArea !== nextArea) {
                    sendEnd(prevArea);
                    lastSegmentTs = performance.now();
                }
            });
        });
    }

    async function createLandmarkers() {
        const vision = await FilesetResolver.forVisionTasks("/vendor/mediapipe/wasm");
        drawingUtils = new DrawingUtils(canvasCtx);
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: `/vendor/mediapipe/models/face_landmarker.task`, delegate: "GPU" },
            outputFaceBlendshapes: true,
            runningMode: "VIDEO",
            numFaces: 1
        });
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: `/vendor/mediapipe/models/hand_landmarker.task`, delegate: "GPU" },
            runningMode: "VIDEO",
            numHands: 2
        });
        statusDiv.textContent = "ìƒíƒœ: ì›¹ìº  ë¡œë”© ì¤‘...";
    }

    function enableCam() {
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
            video.srcObject = stream;
            video.addEventListener("loadeddata", predictWebcam);
            statusDiv.textContent = "ìƒíƒœ: ì›¹ìº  í™œì„±í™”ë¨";
        }).catch((err) => {
            statusDiv.textContent = "ì˜¤ë¥˜: ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨";
            console.error(err);
        });
    }

    async function predictWebcam() {
        // Keep canvas in sync with video
        if (canvasElement.width !== video.videoWidth || canvasElement.height !== video.videoHeight) {
            canvasElement.width = video.videoWidth || 640;
            canvasElement.height = video.videoHeight || 480;
        }

        const nowPerf = performance.now();

        if (lastVideoTime !== video.currentTime && detectionActive) {
            lastVideoTime = video.currentTime;

            // Run detectors
            const faceResults = faceLandmarker.detectForVideo(video, nowPerf);
            const handResults = handLandmarker.detectForVideo(video, nowPerf);

            // Draw results
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (handResults.landmarks) {
                for (const landmarks of handResults.landmarks) {
                    drawingUtils.drawConnectors(landmarks, HandLandmarker.HAND_CONNECTIONS, { color: "#FFFFFF", lineWidth: 2 });
                    drawingUtils.drawLandmarks(landmarks, { color: "#FF0000", lineWidth: 1 });
                }
            }
            if (faceResults.faceLandmarks) {
                for (const landmarks of faceResults.faceLandmarks) {
                    drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "#C0C0C070", lineWidth: 1 });
                }
            }
            canvasCtx.restore();

            // Throttle frame sending
            if (nowPerf - lastSendTime > SEND_INTERVAL_MS) {
                lastSendTime = nowPerf;
                processAndSend(faceResults, handResults);
            }

            // Periodic segment boundary
            if (nowPerf - lastSegmentTs > SEGMENT_MS) {
                sendEnd();
                lastSegmentTs = nowPerf;
            }
        }

        window.requestAnimationFrame(predictWebcam);
    }

    function processAndSend(faceResults, handResults) {
        const faceBlendshapes = faceResults.faceBlendshapes.length > 0
            ? Object.fromEntries(faceResults.faceBlendshapes[0].categories.map(c => [c.categoryName, c.score]))
            : {};

        const getHandData = (handednesses, landmarks, handName) => {
            if (!handednesses || !landmarks) return null;
            const idx = handednesses.findIndex(h => (h[0] && h[0].categoryName) === handName);
            return idx > -1 ? landmarks[idx].map(p => [p.x, p.y, p.z]) : null;
        };

        const frame = {
            timestamp_ms: Date.now(),
            face_blendshapes: faceBlendshapes,
            left_hand_landmarks: getHandData(handResults.handednesses, handResults.landmarks, "Left"),
            right_hand_landmarks: getHandData(handResults.handednesses, handResults.landmarks, "Right")
        };

        if (!socket || socket.readyState !== WebSocket.OPEN) return;

        const normalizedArea = getNormalizedDetectionArea(selectedDetectionArea);
        let features = null;

        if (normalizedArea === 'face') {
            if (Object.keys(faceBlendshapes).length === 0) return;
            const featureKeys = Object.keys(faceBlendshapes).sort();
            features = featureKeys.map(k => Number(faceBlendshapes[k] || 0));

            socket.send(JSON.stringify({
                type: "frame",
                detectionArea: normalizedArea,
                timestamp_ms: frame.timestamp_ms,
                featureKeys: featureKeys,
                features: features
            }));
        } else { // hand
            const right = frame.right_hand_landmarks || null;
            const left = frame.left_hand_landmarks || null;
            if ((!Array.isArray(right) || right.length === 0) && (!Array.isArray(left) || left.length === 0)) {
                return;
            }
            const pointCount = Math.max((right && right.length) || 0, (left && left.length) || 0);
            const vec = [];
            for (let i = 0; i < pointCount; i++) {
                if (right && right[i] && right[i].length >= 3) { vec.push(+right[i][0]||0, +right[i][1]||0, +right[i][2]||0); }
                else { vec.push(0,0,0); }
            }
            for (let i = 0; i < pointCount; i++) {
                if (left && left[i] && left[i].length >= 3) { vec.push(+left[i][0]||0, +left[i][1]||0, +left[i][2]||0); }
                else { vec.push(0,0,0); }
            }
            features = vec;

            socket.send(JSON.stringify({
                type: "frame",
                detectionArea: normalizedArea,
                timestamp_ms: frame.timestamp_ms,
                features: features
            }));
        }
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            window.speechSynthesis.speak(utterance);
        }
    }

    function initWebSocket() {
        const token = getCookie('jwtAccessToken');
        const url = token ? `${WEBSOCKET_URL}?token=${encodeURIComponent(token)}` : WEBSOCKET_URL;

        socket = new WebSocket(url);
        socket.onopen = () => {
            detectionActive = true;
            lastSegmentTs = performance.now();

            // --- UI Bridge: Start ìƒíƒœ ì—…ë°ì´íŠ¸ ---
            phraseDiv.textContent = "-";
            statusDiv.textContent = "ìƒíƒœ: ì„œë²„ ì—°ê²°ë¨ (ì¸ì‹ ì¤‘)";
            setUIStatus(true); // í† ê¸€ê³¼ ìƒë‹¨ í…ìŠ¤íŠ¸ë¥¼ "ì¸ì‹ ì¤‘"ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            // ------------------------------------
        };
        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === "match") {
                    const phrase = data.matched && data.phrase ? data.phrase : "ì¸ì‹ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
                    phraseDiv.textContent = phrase;
                    if (data.matched && data.phrase) speak(data.phrase);
                }
            } catch {
                phraseDiv.textContent = "ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜";
            }
        };
        socket.onerror = () => {
            // Try to close the current segment before closing the socket
            sendEnd();
            if (socket && socket.readyState === WebSocket.OPEN) socket.close();
            phraseDiv.textContent = "WebSocket ì˜¤ë¥˜";
        };
        socket.onclose = () => {
            detectionActive = false;

            // --- UI Bridge: Stop ìƒíƒœ ì—…ë°ì´íŠ¸ ---
            statusDiv.textContent = "ìƒíƒœ: ì—°ê²° ì¢…ë£Œë¨";
            setUIStatus(false); // í† ê¸€ê³¼ ìƒë‹¨ í…ìŠ¤íŠ¸ë¥¼ "ì •ì§€ ì¤‘"ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            // ------------------------------------
        };
    }


    // --- í† ê¸€ ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: UI ë° ê¸°ëŠ¥ ì—°ë™ ---
    if (toggle) {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì • (unchecked = ì •ì§€ ì¤‘)
        setUIStatus(toggle.checked);

        toggle.addEventListener('change', (event) => {
            const isChecked = event.target.checked;

            // 1. UI ìƒíƒœë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            setUIStatus(isChecked);

            if (isChecked) {
                // í† ê¸€ ì¼œì§: ë™ì‘ ì¸ì‹ ì‹œì‘
                if (!socket || socket.readyState === WebSocket.CLOSED) {
                    initWebSocket();
                }
            } else {
                // í† ê¸€ êº¼ì§: ë™ì‘ ì¸ì‹ ì¢…ë£Œ
                if (socket && socket.readyState === WebSocket.OPEN) {
                    detectionActive = false;
                    sendEnd();
                    socket.close();
                }
            }
        });
    }
    // ----------------------------------------


    // Also close segment on page hide/unload
    window.addEventListener('visibilitychange', () => {
        if (document.hidden) sendEnd();
    });
    window.addEventListener('beforeunload', () => {
        sendEnd();
    });

    // === initialize ===
    await createLandmarkers();
    enableCam();
    setupDetectAreaButtons();
</script>
<script src="../js/custom.js"></script>
</body>
</html>