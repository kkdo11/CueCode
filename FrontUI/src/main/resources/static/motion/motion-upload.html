<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <title>MotionLink Demo v0.5 - Motion Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: light; }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #f0f0f0; padding: 24px;
        }
        h1 { margin: 0 0 16px; }
        #container {
            position: relative; width: min(720px, 100%); min-height: 200px;
            border: 2px solid #333; border-radius: 12px; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .status-container { margin-top: 10px; text-align: center; }
        .controls-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #status { font-size: 1.05em; font-weight: 600; color: #333; min-height: 1.2em; }
        button {
            padding: 10px 16px; font-size: 1em; color: white; border: none;
            border-radius: 10px; cursor: pointer; transition: transform .04s ease, opacity .2s, background-color .2s;
            background-color: #4F46E5; box-shadow: 0 2px 8px rgba(79,70,229,.25);
        }
        button:active { transform: translateY(1px); }
        button.alt { background-color: #0ea5e9; }
        button:disabled { background-color: #9aa0a6; cursor: not-allowed; opacity: .75; }
        input[type="text"], select, input[type="number"] {
            padding: 10px; border-radius: 10px; border: 1px solid #d0d0d0; font-size: 1em;
            background: #fff; outline: none;
        }
        input[type="text"]:focus, select:focus, input[type="number"]:focus { border-color: #4F46E5; }
        video { background: #111; border-radius: 10px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .hint { font-size: .9em; color: #666; margin-top: 6px; }
        /* visually hidden (accessible) */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        /* countdown overlay */
        #countdownOverlay {
            position: absolute;
            font-size: 4rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
<h1>MotionLink 동작 영상 업로드 (v0.5)</h1>

<div id="container">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="controls-container">
            <label for="detectionArea" class="sr-only">Detection Area</label>
            <select id="detectionArea" name="detectionArea" required>
                <option value="hands">손</option>
                <option value="face">얼굴</option>
                <option value="eyes">눈</option>
            </select>

            <label for="motionLabel" class="sr-only">Motion Label</label>
            <input type="text" id="motionLabel" name="motionLabel" placeholder="동작 이름 (예: 안녕하세요)" required />
        </div>

        <div style="margin-top:18px; display:flex; flex-direction:column; align-items:center; position:relative;">
            <video id="preview" width="360" height="270" controls autoplay muted playsinline></video>
            <div id="countdownOverlay" aria-hidden="true"></div>

            <div class="row" style="margin-top:10px;">
                <button type="button" id="startBtn" class="alt">녹화 시작 (3s)</button>
                <button type="button" id="resetBtn" disabled>재촬영</button>
            </div>
        </div>

        <button id="uploadButton" type="submit" style="margin-top:16px;">업로드</button>
        <div class="hint">로컬에서는 파일을 직접 열지 말고, <code>http://localhost:8080</code>처럼 <strong>HTTP 서버</strong>에서 실행하세요.</div>
    </form>

    <div class="status-container">
        <div id="status">상태: 대기 중</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const statusDiv = document.getElementById('status');
        const preview = document.getElementById('preview');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const uploadBtn = document.getElementById('uploadButton');
        const form = document.getElementById('uploadForm');
        const countdownOverlay = document.getElementById('countdownOverlay');

        // ---- Config
        const API_GATEWAY_URL = "http://localhost:13000"; // 필요 시 변경
        const RECORD_SECONDS = 3; // fixed recording length
        const COUNTDOWN_SECONDS = 3; // 3-2-1 countdown

        // ---- State
        let mediaRecorder, recordedBlobs = [], stream, videoURL;

        function enable(el, v = true) { el.disabled = !v; }
        function revokeURLSafe(url) { if (url) URL.revokeObjectURL(url); }
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // ---- Recording with countdown and fixed duration
        startBtn.onclick = async () => {
            try {
                recordedBlobs = [];
                revokeURLSafe(videoURL); videoURL = null;

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
                    audio: true
                });
                preview.srcObject = stream;

                const options = { mimeType: 'video/webm; codecs=vp9,opus' };
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch {
                    mediaRecorder = new MediaRecorder(stream);
                }

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) recordedBlobs.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                    videoURL = URL.createObjectURL(superBuffer);
                    preview.srcObject = null;
                    preview.src = videoURL;
                    preview.controls = true;

                    enable(resetBtn, true);
                    statusDiv.textContent = "녹화 완료. 업로드 가능.";
                };

                // prepare UI
                enable(startBtn, false);
                enable(uploadBtn, false);
                enable(resetBtn, false);
                countdownOverlay.style.display = 'block';

                // countdown
                for (let i = COUNTDOWN_SECONDS; i >= 1; i--) {
                    countdownOverlay.textContent = i;
                    statusDiv.textContent = `촬영 시작까지: ${i}`;
                    await sleep(1000);
                }
                countdownOverlay.textContent = "";
                countdownOverlay.style.display = 'none';

                // start recording
                statusDiv.textContent = "녹화 중...";
                mediaRecorder.start();

                // stop automatically after RECORD_SECONDS
                setTimeout(() => {
                    try {
                        mediaRecorder?.stop();
                        stream?.getTracks()?.forEach(t => t.stop());
                        enable(uploadBtn, true);
                        enable(startBtn, true);
                    } catch (e) {
                        console.error(e);
                    }
                }, RECORD_SECONDS * 1000);
            } catch (err) {
                console.error(err);
                statusDiv.textContent = "카메라/마이크 권한 필요 또는 장치 접근 실패.";
                enable(startBtn, true);
                countdownOverlay.style.display = 'none';
            }
        };

        // reset clears recorded video and returns to ready state
        resetBtn.onclick = () => {
            try {
                recordedBlobs = [];
                preview.pause();
                preview.removeAttribute('src');
                preview.srcObject = null;
                revokeURLSafe(videoURL); videoURL = null;

                enable(uploadBtn, true);
                enable(startBtn, true);
                enable(resetBtn, false);

                statusDiv.textContent = "재촬영 준비 완료.";
            } catch (e) {
                console.error(e);
            }
        };

        // ---- Upload (no trimming fields)
        form.onsubmit = async (e) => {
            e.preventDefault();

            const label = document.getElementById('motionLabel').value?.trim();
            const detectionArea = document.getElementById('detectionArea').value;

            if (!label) {
                statusDiv.textContent = "동작 이름을 입력해주세요.";
                return;
            }
            if (!videoURL || !recordedBlobs?.length) {
                statusDiv.textContent = "녹화 영상을 준비해주세요.";
                return;
            }

            try {
                statusDiv.textContent = "업로드 중...";
                enable(uploadBtn, false);

                const uploadBlob = new Blob(recordedBlobs, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('motionLabel', label);
                formData.append('detectionArea', detectionArea);
                formData.append('videoFile', uploadBlob, 'motion.webm');

                const response = await fetch(`${API_GATEWAY_URL}/motions/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.text();
                    statusDiv.textContent = `업로드 성공: ${result}`;
                } else {
                    statusDiv.textContent = `서버 오류: ${response.status}`;
                }
            } catch (error) {
                console.error(error);
                statusDiv.textContent = "업로드 중 오류가 발생했습니다. CORS/네트워크를 확인하세요.";
            } finally {
                enable(uploadBtn, true);
            }
        };
    });
</script>
</body>
</html>
