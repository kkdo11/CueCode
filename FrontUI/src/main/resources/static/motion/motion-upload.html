<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CueCode | ë™ì‘ ì—…ë¡œë“œ</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg" />
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <link rel="stylesheet" href="../css/patient/patient.css" />
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ì½”ë“œë¥¼ ìµœëŒ€í•œ ìœ ì§€í•˜ê³  í•„ìš”í•œ ë¶€ë¶„ë§Œ ìˆ˜ì •í•©ë‹ˆë‹¤. */
        .progress-bar-container { display: flex; justify-content: center; align-items: center; gap: 0; }
        .progress-bar-list { display: flex; list-style: none; padding: 0; margin: 0; width: 100%; justify-content: space-between; align-items: center; }
        .progress-bar-step {
            flex: 1;
            text-align: center;
        }
        .progress-bar-step .circle { width: 32px; height: 32px; border-radius: 50%; background: #e0e0e0; color: #6FC8F8; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 4px; transition: background-color 0.3s, color 0.3s; }
        .progress-bar-step.active .circle { background: #6FC8F8; color: #fff; }
        .progress-bar-line { flex: 0 0 32px; height: 3px; background: #e0e0e0; margin: 0 4px; transition: background-color 0.3s; }

        /* ë‹¨ê³„ë³„ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .step-section { padding: 20px 0; }
        .step-btns { display: flex; justify-content: space-between; margin-top: 30px; }
        .step-btns button { border: none; background: none; cursor: pointer; padding: 0; }
        .step-section h2 { font-size: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .step-section .next-btn iconify-icon, .step-section .prev-btn iconify-icon { color: #6FC8F8; }
        .submit-btn { width: 100%; padding: 10px; background-color: #6FC8F8; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; }
        .submit-btn:disabled { background-color: #9aa0a6; cursor: not-allowed; opacity: .75; }

        /* 1ë‹¨ê³„ (ê°ì§€ ì˜ì—­) ìŠ¤íƒ€ì¼ */
        .detect-btns-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .detect-btns {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            max-width: 480px;
            width: 100%;
        }
        .detect-btn {
            flex: 1;
            padding: 20px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #333;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        .detect-btn.active { border-color: #6FC8F8; background-color: #e6f7ff; color: #6FC8F8; }
        .detect-btn iconify-icon {
            font-size: 2.5rem;
            display: block;
            margin: 0 auto 5px;
        }

        /* ë™ì‘ ì˜ë¯¸ ì…ë ¥ ì¹¸ í…Œë‘ë¦¬ ê°•ì¡° ë° íŒ¨ë”© ì¶”ê°€ */
        .form-control {
            padding-left: 12px;
        }

        input.form-control,
        textarea.form-control {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding-left: 12px;
            transition: border-color .3s, box-shadow .3s;
        }
        input.form-control:focus,
        textarea.form-control:focus {
            border-color: #6FC8F8;
            box-shadow: 0 0 0 .25rem rgba(111,200,248,.25);
        }


        /* ë¹„ë””ì˜¤ ë° ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .video-upload-area { margin-top: 18px; display:flex; flex-direction:column; align-items:center; position:relative; }
        .video-upload-area video
        {
            background: #111;
            border-radius: 10px;
            transform: scaleX(-1);
        }
        .video-controls {
            margin-top:10px;
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 480px;
            padding: 0 10px;
            box-sizing: border-box;
            justify-content: center;
        }
        .video-controls button {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            flex-grow: 1;
        }
        .video-controls button[id^="startBtn"] { background-color: #0ea5e9; color: white; border: none; }
        .video-controls button[id^="resetBtn"] { background-color: #e0e0e0; color: #333; border: none; }
        /* ğŸ’¡ ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .video-controls button[id^="uploadBtn"] {
            background-color: #4F46E5;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }

        /* ìƒíƒœ ì»¨í…Œì´ë„ˆ í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
        .status-container {
            text-align: center;
            margin-top: 10px;
        }
        .status-container div[id^="status"] {
            font-size: 1em;
            font-weight: 600;
            min-height: 1.2em;
        }

        /* ë…¹í™” ì¤‘ ë¹¨ê°„ìƒ‰ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .recording-status {
            color: #dc3545 !important;
        }

        div[id^="countdownOverlay"] {
            position: absolute;
            font-size: 4rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            pointer-events: none;
            display: none;
        }

        /* ğŸ’¡ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .pulse-effect {
            animation: pulse 1.5s infinite;
            background-color: #4F46E5 !important;
        }

        /* ì¹´ë“œ ê°€ë¡œí­ ë³µì› */
        .col-lg-8 { max-width: 720px; }

        /* ğŸ’¡ ë‹¤ìŒ ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬ (ê¸°ë³¸) */
        .step-btns .next-btn {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
        }
        /* ğŸ’¡ ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™” ì‹œ ë³´ì„ (1ë‹¨ê³„ ë° ë…¹í™” ì™„ë£Œ/ì—…ë¡œë“œ ì™„ë£Œ ì‹œ) */
        .step-btns .next-btn.visible {
            visibility: visible;
            opacity: 1;
        }

        /* ğŸ’¡ SweetAlert ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .swal2-actions {
            /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ê°•ì œ ê°€ìš´ë° ì •ë ¬ */
            justify-content: center !important;
            /* ë²„íŠ¼ë“¤ì´ ì„¸ë¡œë¡œ ë°°ì¹˜ë˜ë„ë¡ flex-direction ë³€ê²½ (ì˜µì…˜) */
            /* SweetAlert2ê°€ ê¸°ë³¸ì ìœ¼ë¡œ 'row'ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤„ë°”ê¿ˆì´ ì•ˆ ë˜ë©´ ì˜†ìœ¼ë¡œ ë‚˜ì—´ë¨ */
            flex-direction: column;
            align-items: center;
        }
        /* ê°œë³„ ë²„íŠ¼ì— ë§ˆì§„ì„ ì£¼ì–´ ê°„ê²© í™•ë³´ */
        .swal2-actions button {
            margin: 10px 5px !important; /* ìœ„ì•„ë˜ 10px, ì¢Œìš° 5px ë§ˆì§„ */
            min-width: 250px; /* ë²„íŠ¼ ìµœì†Œ ë„ˆë¹„ ì„¤ì • (ì„ íƒ ì‚¬í•­) */
        }
        .swal2-actions .btn-primary {
            background-color: #6FC8F8 !important;
            border-color: #6FC8F8 !important;
            color: white !important;
        }
        .swal2-actions .btn-secondary {
            background-color: #e0e0e0 !important;
            border-color: #e0e0e0 !important;
            color: #333 !important;
        }
    </style>
</head>
<body>
<header class="header border-4 border-primary border-top position-fixed start-0 top-0 w-100 fixed-header">
    <div class="container">
        <div class="header-wrapper d-flex align-items-center justify-content-between">
            <div class="logo">
                <a href="/index.html" class="logo-white">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
                <a href="/index.html" class="logo-dark">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="btn-group">
                    <button
                            class="btn btn-secondary toggle-menu round-45 p-2 d-flex align-items-center justify-content-center bg-white rounded-circle"
                            type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        <iconify-icon icon="solar:hamburger-menu-line-duotone" class="menu-icon fs-8 text-dark"></iconify-icon>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-4">
                        <div class="d-flex flex-column gap-6">
                            <div class="hstack justify-content-between border-bottom pb-6">
                                <p class="mb-0 fs-5 text-dark">Menu</p>
                                <button type="button" class="btn-close opacity-75" aria-label="Close"></button>
                            </div>
                            <div class="d-flex flex-column gap-3">
                                <ul class="header-menu list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="header-item">
                                        <a href="index.html" aria-current="true"
                                           class="header-link active hstack gap-2 fs-7 fw-bold text-dark"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™ˆ</a>
                                    </li>
                                    <li class="header-item" id="patientMenuItem">
                                        <a href="/patient/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="patientMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™˜ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="managerMenuItem">
                                        <a href="../manager/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="managerMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="myPageMenuItem">
                                        <a href="../user/mypage.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="myPageMenuLinkAnchor"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ë§ˆì´ í˜ì´ì§€</a>
                                    </li>
                                </ul>
                                <div class="hstack gap-3" id="auth-btn-group">
                                    <a href="sign-in.html"
                                       class="btn btn-outline-light fs-6 bg-white px-3 py-2 text-dark w-50 hstack justify-content-center">ë¡œê·¸ì¸</a>
                                    <a href="sign-up.html"
                                       class="btn btn-dark text-white fs-6 bg-dark px-3 py-2 w-50 hstack justify-content-center">íšŒì›ê°€ì…</a>
                                </div>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="container my-5 pt-5">

    <div class="row mb-4 justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 fade-in-up">

            <div id="container" class="p-3 p-md-5 bg-white rounded shadow">
                <form id="uploadForm" enctype="multipart/form-data">

                    <!-- âœ… ì—¬ê¸°ë¶€í„° ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” íŒíŠ¸ ì¹´ë“œ (dashboardì˜ tutorial-bar ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) -->
                    <div class="tutorial-bar info-hint mt-0" style="margin-bottom: 1.5rem">
                        <div class="tutorial-content">
                            <iconify-icon icon="mdi:lightbulb" class="tutorial-icon"></iconify-icon>
                            <div class="tutorial-text">
                                <h6 class="mb-0">ìë™ ë™ì‘ ì‚¬ì „ ë¶ˆëŸ¬ì˜¤ê¸°</h6>
                                <p class="mb-0">
                                    ìš°ë¦¬ëŠ” ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•´ <b>ëˆˆ, ì–¼êµ´, ì†(ê¸°ë³¸Â·ìˆ˜ì–´)</b> ë™ì‘ ì‚¬ì „ì„ ì¶”ê°€í–ˆì–´ìš”.<br><b>ì‹¤ì‹œê°„ ë™ì‘ ì¸ì‹ í˜ì´ì§€</b>ì—ì„œ
                                    <span class="text-primary fw-semibold">ë™ì‘ ì¸ì‹</span>ì„ í™œì„±í™”í•˜ë©´ ì‹¤ì‹œê°„ ì¸ì‹ì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="progress-bar-container mb-4 mb-md-5">
                        <ul class="progress-bar-list">
                            <li class="progress-bar-step active" id="step1-bar">
                                <div class="circle">1</div>
                                <div class="step-label">ë™ì‘ ì •ì˜</div>
                            </li>
                            <li class="progress-bar-line" id="line1"></li>
                            <li class="progress-bar-step" id="step2-bar">
                                <div class="circle">2</div>
                                <div class="step-label">1ì°¨ ì´¬ì˜</div>
                            </li>
                            <li class="progress-bar-line" id="line2"></li>
                            <li class="progress-bar-step" id="step3-bar">
                                <div class="circle">3</div>
                                <div class="step-label">2ì°¨ ì´¬ì˜</div>
                            </li>
                            <li class="progress-bar-line" id="line3"></li>
                            <li class="progress-bar-step" id="step4-bar">
                                <div class="circle">4</div>
                                <div class="step-label">3ì°¨ ì´¬ì˜</div>
                            </li>
                        </ul>
                    </div>
                    <div id="step-form-container">

                        <section class="step-section" id="step1">
                            <h2 class="fw-semibold text-secondary">1. ë™ì‘ ê°ì§€ ì˜ì—­ ë° ì´ë¦„ ì •ì˜</h2>

                            <div class="form-group mb-4">
                                <label for="detectionArea" class="form-label fw-bold">ê°ì§€ ì˜ì—­</label>
                                <div class="detect-btns-container">
                                    <div class="detect-btns" id="detectBtns">
                                        <div class="detect-btn active" data-value="hands">
                                            <iconify-icon icon="lucide:hand"></iconify-icon>
                                            ì†
                                        </div>
                                        <div class="detect-btn" data-value="face">
                                            <iconify-icon icon="lucide:scan-face"></iconify-icon>
                                            ì–¼êµ´
                                        </div>
                                        <div class="detect-btn" data-value="eyes">
                                            <iconify-icon icon="lucide:eye"></iconify-icon>
                                            ëˆˆ
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="detectionArea" name="detectionArea" value="hands" required>
                            </div>

                            <div class="form-group mb-4">
                                <label for="motionLabel" class="form-label fw-bold">ë™ì‘ ì˜ë¯¸</label>
                                <input type="text" id="motionLabel" name="motionLabel" class="form-control"
                                       placeholder="ë‚˜ë§Œì˜ ì˜ë¯¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”, ê°ì‚¬í•´ìš”)" required />
                            </div>

                            <div class="form-group mb-4">
                                <label for="motionDescription" class="form-label fw-bold">ê°„ë‹¨í•œ ì„¤ëª… (ì„ íƒ)</label>
                                <textarea id="motionDescription" name="motionDescription" class="form-control"
                                          placeholder="ë™ì‘ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì†ì„ ë†’ì´ ë“¤ê³  ì¸ì‚¬í•¨)" rows="3"></textarea>
                            </div>

                            <div class="step-btns justify-content-end">
                                <button type="button" class="next-btn visible" data-next-step="2" id="nextBtn1">
                                    <iconify-icon icon="fa:arrow-right" width="28" height="28"></iconify-icon>
                                </button>
                            </div>
                        </section>

                        <section class="step-section" id="step2" style="display:none;">
                            <h2 class="fw-semibold text-secondary">2. 1ì°¨ ì˜ìƒ ì´¬ì˜</h2>
                            <div class="video-upload-area">
                                <video id="preview2" width="640" height="480" controls autoplay muted playsinline></video>
                                <div id="countdownOverlay2" aria-hidden="true"></div>

                                <div class="video-controls">
                                    <button type="button" id="startBtn2">ë…¹í™” ì‹œì‘ (3s)</button>
                                    <button type="button" id="resetBtn2" disabled>ì¬ì´¬ì˜</button>
                                    <button type="button" id="uploadBtn2" disabled>ì—…ë¡œë“œ</button>
                                </div>
                            </div>
                            <div class="status-container mt-3">
                                <div id="status2">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
                            </div>
                            <div class="step-btns">
                                <button type="button" class="prev-btn" data-prev-step="1">
                                    <iconify-icon icon="fa:arrow-left" width="28" height="28"></iconify-icon>
                                </button>
                                <button type="button" class="next-btn" data-next-step="3" id="nextBtn2">
                                    <iconify-icon icon="fa:arrow-right" width="28" height="28"></iconify-icon>
                                </button>
                            </div>
                        </section>

                        <section class="step-section" id="step3" style="display:none;">
                            <h2 class="fw-semibold text-secondary">3. 2ì°¨ ì˜ìƒ ì´¬ì˜</h2>
                            <div class="video-upload-area">
                                <video id="preview3" width="640" height="480" controls autoplay muted playsinline></video>
                                <div id="countdownOverlay3" aria-hidden="true"></div>

                                <div class="video-controls">
                                    <button type="button" id="startBtn3">ë…¹í™” ì‹œì‘ (3s)</button>
                                    <button type="button" id="resetBtn3" disabled>ì¬ì´¬ì˜</button>
                                    <button type="button" id="uploadBtn3" disabled>ì—…ë¡œë“œ</button>
                                </div>
                            </div>
                            <div class="status-container mt-3">
                                <div id="status3">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
                            </div>
                            <div class="hint mt-3 text-center text-muted small">
                                1ì°¨ì™€ ë™ì¼í•œ ë™ì‘ì„ ë‹¤ë¥¸ ê°ë„(ì˜ˆ: ì¸¡ë©´)ì—ì„œ ì´¬ì˜í•´ë³´ì„¸ìš”.
                            </div>

                            <div class="step-btns">
                                <button type="button" class="prev-btn" data-prev-step="2">
                                    <iconify-icon icon="fa:arrow-left" width="28" height="28"></iconify-icon>
                                </button>
                                <button type="button" class="next-btn" data-next-step="4" id="nextBtn3">
                                    <iconify-icon icon="fa:arrow-right" width="28" height="28"></iconify-icon>
                                </button>
                            </div>
                        </section>

                        <section class="step-section" id="step4" style="display:none;">
                            <h2 class="fw-semibold text-secondary">4. 3ì°¨ ì˜ìƒ ì´¬ì˜ ë° ìµœì¢… ì œì¶œ</h2>
                            <div class="video-upload-area">
                                <video id="preview4" width="640" height="480" controls autoplay muted playsinline></video>
                                <div id="countdownOverlay4" aria-hidden="true"></div>

                                <div class="video-controls">
                                    <button type="button" id="startBtn4">ë…¹í™” ì‹œì‘ (3s)</button>
                                    <button type="button" id="resetBtn4" disabled>ì¬ì´¬ì˜</button>
                                    <button type="button" id="uploadBtn4" disabled>ì—…ë¡œë“œ</button>
                                </div>
                            </div>
                            <div class="status-container mt-3">
                                <div id="status4">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
                            </div>
                            <div class="hint mt-3 text-center text-muted small">
                                ë‹¤ì–‘í•œ í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬ 3ë²ˆì§¸ ì˜ìƒì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.
                            </div>

                            <div class="step-btns">
                                <button type="button" class="prev-btn" data-prev-step="3">
                                    <iconify-icon icon="fa:arrow-left" width="28" height="28"></iconify-icon>
                                </button>
                            </div>
                        </section>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<footer class="footer bg-dark py-5 py-lg-11 py-xl-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-5 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-8 pe-xl-5">
                    <h4 class="mb-0 text-white">ì´ í”„ë¡œì íŠ¸ëŠ” <br> 2025 ìƒˆì‹¹ í•´ì»¤í†¤
                        <br>ê³µëª¨ì „ ì¶œí’ˆì‘ì…ë‹ˆë‹¤</h4>
                </div>
            </div>
            <div class="col-md-6 col-xl-4 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-2">
                    <a href="https://dacon.io/competitions/official/236624/overview/description" target="_blank" class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:arrow-up-right" class="fs-7 text-primary"></iconify-icon>
                        https://dacon.io
                    </a>
                    <a href="https://buly.kr/Awg81rV" target="_blank"
                       class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:map-pin" class="fs-7 text-primary"></iconify-icon>
                        200ok
                    </a>
                </div>
            </div>
            <div class="col-md-4 col-xl-3 mb-8 mb-xl-0">
                <p class="mb-0 text-white text-opacity-70 text-md-end">Â© CueCode copyright 2025</p>
            </div>
        </div>
    </div>
    <p class="mb-0 text-white text-opacity-70 text-md-center mt-10">Distributed by <a class="text-white"  target="_blank">Team Ujangsan Spirit</a></p>
</footer>
<div class="get-template hstack gap-2">
    <button class="btn bg-primary p-2 round-52 rounded-circle hstack justify-content-center flex-shrink-0"
            id="scrollToTopBtn">
        <iconify-icon icon="lucide:arrow-up" class="fs-7 text-dark"></iconify-icon>
    </button>
</div>


<script src="../js/user/index.js"></script>
<script src="../js/config.js"></script>
<script src="../libs/jquery/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/owl.carousel/dist/owl.carousel.min.js"></script>
<script src="../libs/aos-master/dist/aos.js"></script>
<script src="../js/custom.js"></script>

<script>
    // ìœ í‹¸: ì¿ í‚¤ ì¡°íšŒ
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // ì•¡ì„¸ìŠ¤ í† í° íšë“
    function getAccessToken() {
        return getCookie('jwtAccessToken');
    }

    // JWT ë””ì½”ë”© í›„ ì½˜ì†”ì— ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
    function logDecodedToken(token, source) {
        try {
            const decoded = jwt_decode(token);
            console.group(`ğŸ”” JWT í† í° ë””ì½”ë”©ëœ ê°œì¸ ì •ë³´ (${source})`);
            console.log('í† í° ì¡´ì¬:', true);
            console.log('ë°œê¸‰ ì‹œê°„ (iat):', new Date(decoded.iat * 1000).toLocaleString());
            console.log('ë§Œë£Œ ì‹œê°„ (exp):', new Date(decoded.exp * 1000).toLocaleString());
            console.log('ì „ì²´ í˜ì´ë¡œë“œ:', decoded);
            console.groupEnd();
            return decoded;
        } catch (e) {
            console.warn(`JWT ë””ì½”ë”© ì‹¤íŒ¨ (${source}):`, e);
            return null;
        }
    }

    // 10ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í—¬í¼
    function redirectToSignInWithDelay(statusEl, url, seconds = 10) {
        statusEl.textContent = `ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ${seconds}ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...`;
        setTimeout(() => {
            window.location.href = url;
        }, seconds * 1000);
    }

    // ë¹„ë™ê¸° ì¸ì¦ í™•ì¸
    async function checkAuth(apiBase) {
        const token = getAccessToken();
        if (token) {
            logDecodedToken(token, 'í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ ì²´í¬');
            return true;
        }
        try {
            // ì„œë²„ì— /user/me ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆë‹¤ê³  ê°€ì •
            const resp = await fetch(`${apiBase}/user/me`, { method: 'GET', credentials: 'include' });
            if (resp.ok) {
                console.log('HTTP-Only ì¿ í‚¤ë¥¼ í†µí•œ ì„œë²„ ì¸ì¦ ì„±ê³µ.');
                return true;
            }
            return false;
        } catch (e) {
            console.warn('Auth check failed (Server API access error):', e);
            return false;
        }
    }

    const SIGN_IN_PAGE_URL = '/user/sign-in.html';
    // config.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì „ì—­ API_BASE ë³€ìˆ˜ ëŒ€ì‹  try-catchë¡œ ëŒ€ì²´
    const API_GATEWAY_URL = window.API_BASE;
    const RECORD_SECONDS = 3;
    const COUNTDOWN_SECONDS = 3;

    // ë‹¨ê³„ë³„ ì˜ìƒ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´. í‚¤: ë‹¨ê³„ ë²ˆí˜¸(2, 3, 4)
    // isRecorded: ë…¹í™” ì™„ë£Œ ì—¬ë¶€, isUploaded: ì—…ë¡œë“œ ì™„ë£Œ ì—¬ë¶€
    const recordedVideos = {};

    function enable(el, v = true) { if(el) el.disabled = !v; }
    function revokeURLSafe(url) { if (url) URL.revokeObjectURL(url); }
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // ---- ë‹¤ë‹¨ê³„ í¼ ì²˜ë¦¬ ë¡œì§ ----
    let currentStep = 1;
    const totalSteps = 4;
    const stepSections = document.querySelectorAll('.step-section');
    const stepBars = document.querySelectorAll('.progress-bar-step');
    const progressLines = document.querySelectorAll('.progress-bar-line');

    function updateProgressBar(step) {
        stepBars.forEach((bar, index) => {
            if (index + 1 <= step) {
                bar.classList.add('active');
            } else {
                bar.classList.remove('active');
            }
        });

        progressLines.forEach((line, index) => {
            if (index + 2 <= step) {
                line.style.backgroundColor = '#6FC8F8';
            } else {
                line.style.backgroundColor = '#e0e0e0';
            }
        });
    }

    // ë‹¤ìŒ ë²„íŠ¼ ê°€ì‹œì„± ì œì–´ í•¨ìˆ˜ (CSS í´ë˜ìŠ¤ ì‚¬ìš©)
    function setNextButtonVisibility(nextBtnElement, isVisible) {
        if (nextBtnElement) {
            if (isVisible) {
                nextBtnElement.classList.add('visible');
            } else {
                nextBtnElement.classList.remove('visible');
            }
        }
    }


    function showStep(step) {
        if (step < 1 || step > totalSteps) return;

        stepSections.forEach(section => {
            section.style.display = 'none';
        });

        document.getElementById(`step${step}`).style.display = 'block';
        currentStep = step;

        updateProgressBar(step);

        const nextBtnElement = document.getElementById(`nextBtn${step}`);
        const isUploaded = recordedVideos[step]?.isUploaded;

        // 1ë‹¨ê³„ ë²„íŠ¼ì€ í•­ìƒ ë³´ì„
        if (step === 1) {
            setNextButtonVisibility(nextBtnElement, true);
        } else if (step >= 2 && step < totalSteps) {
            // 2~3ë‹¨ê³„ëŠ” ì—…ë¡œë“œ ì™„ë£Œ ì‹œ ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
            setNextButtonVisibility(nextBtnElement, isUploaded);
        }

        // **í•µì‹¬: 2ë‹¨ê³„ë¶€í„°ëŠ” ì˜ìƒ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ**
        if (step >= 2) {
            initializeVideoStep(step);
        }
    }

    // ë‹¤ìŒ ë²„íŠ¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ì´ë™
    async function goToNextStep(nextStep) {
        // 1ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬
        if (currentStep === 1) {
            const label = document.getElementById('motionLabel').value?.trim();
            if (!label) {
                await Swal.fire('ê²½ê³ ', 'ë™ì‘ ì˜ë¯¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
        }
        // 2, 3ë‹¨ê³„ ìœ íš¨ì„± ê²€ì‚¬ (ì—…ë¡œë“œ ì™„ë£Œ ì—¬ë¶€)
        if (currentStep >= 2 && currentStep < totalSteps) {
            if (!recordedVideos[currentStep]?.isUploaded) {
                await Swal.fire('ê²½ê³ ', `${currentStep-1}ì°¨ ì˜ìƒì˜ ë…¹í™” ë° ì—…ë¡œë“œë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.`, 'warning');
                return;
            }
        }
        showStep(nextStep);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
    function setupStepEventListeners() {
        document.querySelectorAll('.next-btn').forEach(button => {
            button.addEventListener('click', () => {
                const nextStep = parseInt(button.dataset.nextStep);
                goToNextStep(nextStep);
            });
        });

        document.querySelectorAll('.prev-btn').forEach(button => {
            button.addEventListener('click', () => {
                const prevStep = currentStep - 1;
                showStep(prevStep);
            });
        });

        document.querySelectorAll('#detectBtns .detect-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#detectBtns .detect-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('detectionArea').value = this.dataset.value;
            });
        });
    }

    // ëª¨ë“  ë‹¨ê³„ê°€ ë…¹í™” ë° ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ìµœì¢… ì œì¶œ ë²„íŠ¼ìš© - í˜„ì¬ ë¯¸ì‚¬ìš©)
    function isAllUploaded() {
        return recordedVideos[2]?.isUploaded && recordedVideos[3]?.isUploaded && recordedVideos[4]?.isUploaded;
    }


    // ---- ì˜ìƒ ì´¬ì˜/ì¬ì´¬ì˜/ì—…ë¡œë“œ ë¡œì§ (í•µì‹¬) ----

    function initializeVideoStep(stepNumber) {
        // IDëŠ” HTML ë‹¨ê³„ ë²ˆí˜¸ì™€ ë§ì¶¥ë‹ˆë‹¤ (2, 3, 4)
        const preview = document.getElementById(`preview${stepNumber}`);
        const startBtn = document.getElementById(`startBtn${stepNumber}`);
        const resetBtn = document.getElementById(`resetBtn${stepNumber}`);
        const uploadBtn = document.getElementById(`uploadBtn${stepNumber}`);
        const statusDiv = document.getElementById(`status${stepNumber}`);
        const nextBtn = document.getElementById(`nextBtn${stepNumber}`);
        const countdownOverlay = document.getElementById(`countdownOverlay${stepNumber}`);
        const isFinalStep = stepNumber === totalSteps;
        // ìµœì¢… ì œì¶œ ë²„íŠ¼ì€ ì£¼ì„ ì²˜ë¦¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë¯¸ì‚¬ìš©
        // const finalUploadBtn = document.getElementById('finalUploadButton');

        if (!preview || !startBtn || !uploadBtn) {
            console.error(`DOM elements for step ${stepNumber} not found.`);
            return;
        }

        let mediaRecorder;

        // ë‹¨ê³„ë³„ ë°ì´í„° ì´ˆê¸°í™” ë° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if (!recordedVideos[stepNumber]) {
            recordedVideos[stepNumber] = { blob: null, url: null, stream: null, isRecorded: false, isUploaded: false };
        }

        let { stream } = recordedVideos[stepNumber];

        // ìƒíƒœ í´ë˜ìŠ¤ ì´ˆê¸°í™”
        statusDiv.classList.remove('recording-status');
        uploadBtn.classList.remove('pulse-effect');

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        const isRecorded = recordedVideos[stepNumber].isRecorded;
        const isUploaded = recordedVideos[stepNumber].isUploaded;

        statusDiv.textContent = 'ì¹´ë©”ë¼ ì—°ê²°ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...'; // ì¹œê·¼í•œ ë¬¸êµ¬

        enable(startBtn, false);
        enable(resetBtn, false);
        enable(uploadBtn, false);
        // if (isFinalStep) enable(finalUploadBtn, isAllUploaded()); // ìµœì¢… ì œì¶œ ë²„íŠ¼ ë¯¸ì‚¬ìš©
        if (nextBtn) setNextButtonVisibility(nextBtn, isUploaded);


        // ë…¹í™” ê¸°ë¡ì´ ìˆë‹¤ë©´ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì„¤ì •í•˜ê³  ë²„íŠ¼ í™œì„±í™”
        if (isRecorded) {
            preview.src = recordedVideos[stepNumber].url;
            preview.controls = true;
            statusDiv.textContent = isUploaded
                ? 'âœ… ì—…ë¡œë“œ ì™„ë£Œ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.'
                : 'âœ… ë…¹í™” ì™„ë£Œ! ì˜ìƒì„ í™•ì¸ í›„ ì—…ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';

            enable(startBtn, false);
            enable(resetBtn, true);
            enable(uploadBtn, !isUploaded);
            if (!isUploaded) uploadBtn.classList.add('pulse-effect');
            return;
        }

        // --- ì¹´ë©”ë¼ ì ‘ê·¼ ë° ì´ˆê¸°í™” í•¨ìˆ˜ ---
        async function setupCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
                    audio: true
                });

                recordedVideos[stepNumber].stream = stream;
                preview.srcObject = stream;
                preview.controls = false;
                statusDiv.textContent = 'ğŸ¥ ë…¹í™” ì¤€ë¹„ ì™„ë£Œ! "ë…¹í™” ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                enable(startBtn, true);

            } catch (error) {
                statusDiv.textContent = `âŒ ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨: ì¥ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
                console.error("Camera access error: ", error);
                await Swal.fire('ì˜¤ë¥˜', 'ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›¹ì‚¬ì´íŠ¸ì˜ ê¶Œí•œ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                enable(startBtn, false);
            }
        }

        // --- ë…¹í™” ì‹œì‘ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        startBtn.onclick = async () => {
            if (!stream) {
                await setupCamera();
                stream = recordedVideos[stepNumber].stream;
                if (!stream) return;
            }

            let loggedIn = await checkAuth(API_GATEWAY_URL);
            if (!loggedIn) {
                redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                return;
            }

            let recordedChunks = [];

            const options = { mimeType: 'video/webm; codecs=vp9,opus' };
            try { mediaRecorder = new MediaRecorder(stream, options); }
            catch { mediaRecorder = new MediaRecorder(stream); }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
                stream?.getTracks().forEach(t => t.stop());
                recordedVideos[stepNumber].stream = null;
                stream = null;

                statusDiv.classList.remove('recording-status');

                const superBuffer = new Blob(recordedChunks, { type: 'video/webm' });
                const videoURL = URL.createObjectURL(superBuffer);

                // ë°ì´í„° ì €ì¥
                revokeURLSafe(recordedVideos[stepNumber].url);
                recordedVideos[stepNumber].blob = superBuffer;
                recordedVideos[stepNumber].url = videoURL;
                recordedVideos[stepNumber].isRecorded = true;
                recordedVideos[stepNumber].isUploaded = false; // ë…¹í™” í›„ ì—…ë¡œë“œ ìƒíƒœ ì´ˆê¸°í™”

                // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                preview.srcObject = null;
                preview.src = videoURL;
                preview.controls = true;
                enable(resetBtn, true);
                enable(startBtn, false);
                enable(uploadBtn, true); // ğŸ’¡ ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                uploadBtn.classList.add('pulse-effect'); // ğŸ’¡ ë°˜ì§ì„ íš¨ê³¼ ì¶”ê°€
                if (nextBtn) setNextButtonVisibility(nextBtn, false); // ğŸ’¡ ë‹¤ìŒ ë²„íŠ¼ ìˆ¨ê¹€
                // if (isFinalStep) enable(finalUploadBtn, false); // ìµœì¢… ì œì¶œ ë²„íŠ¼ ë¯¸ì‚¬ìš©

                statusDiv.textContent = "âœ… ë…¹í™” ì™„ë£Œ! ì˜ìƒì„ í™•ì¸ í›„ ì—…ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            };

            // UI ì¤€ë¹„ ë° ì¹´ìš´íŠ¸ë‹¤ìš´
            enable(startBtn, false);
            if (nextBtn) setNextButtonVisibility(nextBtn, false); // ğŸ’¡ ë…¹í™” ì‹œì‘ ì‹œ ë‹¤ìŒ ë²„íŠ¼ ìˆ¨ê¹€
            enable(resetBtn, false);
            enable(uploadBtn, false); // ğŸ’¡ ì—…ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
            // if(isFinalStep) enable(finalUploadBtn, false); // ìµœì¢… ì œì¶œ ë²„íŠ¼ ë¯¸ì‚¬ìš©
            countdownOverlay.style.display = 'block';

            // countdown
            for (let i = COUNTDOWN_SECONDS; i >= 1; i--) {
                countdownOverlay.textContent = i;
                statusDiv.textContent = `ğŸš€ ì´¬ì˜ ì‹œì‘ê¹Œì§€: ${i}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤!`;
                await sleep(1000);
            }
            countdownOverlay.textContent = "";
            countdownOverlay.style.display = 'none';

            // start recording
            statusDiv.classList.add('recording-status');
            statusDiv.textContent = "ğŸ”´ ë…¹í™” ì¤‘! ë™ì‘ì„ ì²œì²œíˆ ë³´ì—¬ì£¼ì„¸ìš”. (3ì´ˆ)";
            mediaRecorder.start();

            // stop automatically
            setTimeout(() => {
                try {
                    if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
                } catch (e) { console.error(e); }
            }, RECORD_SECONDS * 1000);
        };

        // --- ì¬ì´¬ì˜ í•¨ìˆ˜ ---
        resetBtn.onclick = async () => {
            revokeURLSafe(recordedVideos[stepNumber]?.url);
            recordedVideos[stepNumber].blob = null;
            recordedVideos[stepNumber].url = null;
            recordedVideos[stepNumber].stream = null;
            recordedVideos[stepNumber].isRecorded = false;
            recordedVideos[stepNumber].isUploaded = false;

            preview.pause();
            preview.removeAttribute('src');
            preview.srcObject = null;
            preview.controls = false;

            if (nextBtn) setNextButtonVisibility(nextBtn, false);
            // if (isFinalStep) enable(finalUploadBtn, false); // ìµœì¢… ì œì¶œ ë²„íŠ¼ ë¯¸ì‚¬ìš©
            enable(resetBtn, false);
            enable(uploadBtn, false);
            uploadBtn.classList.remove('pulse-effect'); // ğŸ’¡ ë°˜ì§ì„ ì œê±°

            statusDiv.textContent = 'ğŸ“· ì¬ì´¬ì˜ ì¤€ë¹„ ì™„ë£Œ! ì¹´ë©”ë¼ë¥¼ ë‹¤ì‹œ ì¼œê³  ìˆì–´ìš”.';

            await setupCamera();
        };

        // --- ì—…ë¡œë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ìˆ˜ì •ëœ ë¶€ë¶„) ---
        uploadBtn.onclick = async () => {
            // read latest inputs (motionLabel and motionDescription)
            const label = document.getElementById('motionLabel').value?.trim();
            const description = document.getElementById('motionDescription').value?.trim();
            const detectionArea = document.getElementById('detectionArea').value;

            if (!label) {
                await Swal.fire('ê²½ê³ ', '1ë‹¨ê³„ì—ì„œ ë™ì‘ ì˜ë¯¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                showStep(1);
                return;
            }
            if (!recordedVideos[stepNumber]?.blob) {
                await Swal.fire('ê²½ê³ ', 'ë¨¼ì € ì˜ìƒì„ ë…¹í™”í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            let loggedIn = await checkAuth(API_GATEWAY_URL);
            if (!loggedIn) {
                redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                return;
            }

            try {
                statusDiv.textContent = "ğŸ“¤ ì˜ìƒì„ ì„œë²„ì— ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...";
                enable(uploadBtn, false);
                enable(resetBtn, false);
                uploadBtn.classList.remove('pulse-effect'); // remove pulse while uploading

                const formData = new FormData();
                formData.append('motionLabel', label);
                formData.append('motionDescription', description);
                formData.append('detectionArea', detectionArea);
                // send single file per step
                formData.append('videoFile', recordedVideos[stepNumber].blob, `motion_${stepNumber-1}.webm`);

                const response = await fetch(`${API_GATEWAY_URL}/motions/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    recordedVideos[stepNumber].isUploaded = true;
                    enable(resetBtn, true); // ì¬ì´¬ì˜ì€ ê°€ëŠ¥

                    // 4ë‹¨ê³„(ìµœì¢…) ì—…ë¡œë“œ ì„±ê³µ ì‹œ íŠ¹ìˆ˜ ì²˜ë¦¬
                    if (stepNumber === totalSteps) {
                        statusDiv.textContent = `â­ 3ì°¨ ì˜ìƒ ì—…ë¡œë“œ ì„±ê³µ! ìµœì¢… ë™ì‘ ë“±ë¡ ì™„ë£Œ.`;
                        // SweetAlert2 ì•Œë¦¼ì°½ ë„ìš°ê¸° ë° ë²„íŠ¼ ê²½ë¡œ ì„¤ì •
                        Swal.fire({
                            title: 'ğŸ‰ ëª¨ë“  ì˜ìƒ ì—…ë¡œë“œ ë° ë“±ë¡ ì™„ë£Œ!',
                            html: 'ì´ì œ ì‹¤ì‹œê°„ ë™ì‘ ì¸ì‹ì„ ì‹œì‘í•˜ê±°ë‚˜, ë‹¤ë¥¸ ë™ì‘ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'ì‹¤ì‹œê°„ ë™ì‘ ì¸ì‹ ì‹œì‘í•˜ê¸°',
                            cancelButtonText: 'ë™ì‘ ì—…ë¡œë“œ ì´ì–´ì„œ í•˜ê¸°',
                            reverseButtons: true,
                            customClass: {
                                // SweetAlert2 ê¸°ë³¸ ë²„íŠ¼ í´ë˜ìŠ¤ë¥¼ ì¬ì •ì˜
                                confirmButton: 'btn btn-primary swal2-confirm',
                                cancelButton: 'btn btn-secondary swal2-cancel'
                            },
                            buttonsStyling: false, // ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ false ì„¤ì •
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // "ì‹¤ì‹œê°„ ë™ì‘ ì¸ì‹ ì‹œì‘í•˜ê¸°" í´ë¦­ ì‹œ
                                window.location.href = '../motion/motion-detector.html';
                            } else if (result.dismiss === Swal.DismissReason.cancel) {
                                // "ë™ì‘ ì—…ë¡œë“œ ì´ì–´ì„œ í•˜ê¸°" í´ë¦­ ì‹œ (í˜ì´ì§€ ì´ˆê¸°í™”)
                                window.location.href = '../motion/motion-upload.html';
                            }
                        });

                    } else {
                        // 2, 3ë‹¨ê³„ ì—…ë¡œë“œ ì„±ê³µ
                        statusDiv.textContent = `â­ ì—…ë¡œë“œ ì„±ê³µ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ ì£¼ì„¸ìš”.`;
                        if (nextBtn) setNextButtonVisibility(nextBtn, true);
                        await Swal.fire('ì—…ë¡œë“œ ì™„ë£Œ', `${stepNumber-1}ì°¨ ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.`, 'success');
                    }

                } else if (response.status === 401) {
                    redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                } else {
                    const text = await response.text().catch(() => 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    statusDiv.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status} (${text.substring(0, 50)}...)`;
                    enable(uploadBtn, true);
                    enable(resetBtn, true);
                    uploadBtn.classList.add('pulse-effect');
                    await Swal.fire('ì˜¤ë¥˜', `ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error("Upload error:", error);
                statusDiv.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                enable(uploadBtn, true);
                enable(resetBtn, true);
                uploadBtn.classList.add('pulse-effect');
                await Swal.fire('ì˜¤ë¥˜', 'ì—…ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

        // ë‹¨ê³„ ì§„ì… ì‹œ ì¹´ë©”ë¼ ì„¤ì •
        if (!recordedVideos[stepNumber].isRecorded) {
            setupCamera();
        }
    }


    // ---- ìµœì¢… ì œì¶œ ë¡œì§ (í˜„ì¬ëŠ” 4ë‹¨ê³„ ì—…ë¡œë“œ ì„±ê³µì— í†µí•©ë˜ì–´ ë¯¸ì‚¬ìš©) ----

    document.addEventListener('DOMContentLoaded', async () => {
        setupStepEventListeners();

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ë¹„í™œì„±í™” (4ë‹¨ê³„ ê°œë³„ ì—…ë¡œë“œ ë²„íŠ¼ì— ë¡œì§ í†µí•©)
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            // ìµœì¢… ì œì¶œ ë¡œì§ì´ ê°œë³„ ì—…ë¡œë“œ ë²„íŠ¼ì— í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ê²½ê³ ë§Œ ë„ì›ë‹ˆë‹¤.
            console.warn("Final form submission is disabled and handled by the Step 4 upload button.");
            // 4ë‹¨ê³„ ì—…ë¡œë“œ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ë„ë¡ ìœ ë„
            if (currentStep === totalSteps && !recordedVideos[totalSteps]?.isUploaded) {
                await Swal.fire('ì•Œë¦¼', '3ì°¨ ì˜ìƒì˜ "ì—…ë¡œë“œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì¢… ë“±ë¡ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'info');
            } else if (currentStep !== totalSteps) {
                await Swal.fire('ì•Œë¦¼', 'ëª¨ë“  ë‹¨ê³„(1~4ë‹¨ê³„)ë¥¼ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.', 'info');
            }
            return false;
        };

        // ì´ˆê¸° ì¸ì¦ í™•ì¸
        let loggedIn = await checkAuth(API_GATEWAY_URL);
        const initialStatusDiv = document.getElementById('status2');
        if (loggedIn) {
            initialStatusDiv.textContent = 'âœ… ë¡œê·¸ì¸ ì™„ë£Œ! 1ë‹¨ê³„ì—ì„œ ë™ì‘ì„ ì •ì˜í•˜ê³  2ë‹¨ê³„ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.';
        } else {
            initialStatusDiv.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            await Swal.fire('ì•Œë¦¼', 'ë™ì‘ ì—…ë¡œë“œëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
        }

        showStep(1);
    });
</script>
</body>
</html>