<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <link rel="icon" href="data:," />
    <title>MotionLink Demo v0.5 - Motion Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: light; }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #f0f0f0; padding: 24px;
        }
        h1 { margin: 0 0 16px; }
        #container {
            position: relative; width: min(720px, 100%); min-height: 200px;
            border: 2px solid #333; border-radius: 12px; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .status-container { margin-top: 10px; text-align: center; }
        .controls-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #status { font-size: 1.05em; font-weight: 600; color: #333; min-height: 1.2em; }
        button {
            padding: 10px 16px; font-size: 1em; color: white; border: none;
            border-radius: 10px; cursor: pointer; transition: transform .04s ease, opacity .2s, background-color .2s;
            background-color: #4F46E5; box-shadow: 0 2px 8px rgba(79,70,229,.25);
        }
        button:active { transform: translateY(1px); }
        button.alt { background-color: #0ea5e9; }
        button:disabled { background-color: #9aa0a6; cursor: not-allowed; opacity: .75; }
        input[type="text"], select, input[type="number"] {
            padding: 10px; border-radius: 10px; border: 1px solid #d0d0d0; font-size: 1em;
            background: #fff; outline: none;
        }
        input[type="text"]:focus, select:focus, input[type="number"]:focus { border-color: #4F46E5; }
        video { background: #111; border-radius: 10px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .hint { font-size: .9em; color: #666; margin-top: 6px; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        #countdownOverlay {
            position: absolute;
            font-size: 4rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
<h1>MotionLink ë™ì‘ ì˜ìƒ ì—…ë¡œë“œ (v0.5)</h1>

<div id="container">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="controls-container">
            <label for="detectionArea" class="sr-only">Detection Area</label>
            <select id="detectionArea" name="detectionArea" required>
                <option value="hands">ì†</option>
                <option value="face">ì–¼êµ´</option>
                <option value="eyes">ëˆˆ</option>
            </select>

            <label for="motionLabel" class="sr-only">Motion Label</label>
            <input type="text" id="motionLabel" name="motionLabel" placeholder="ë™ì‘ ì´ë¦„ (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”)" required />
        </div>

        <div style="margin-top:18px; display:flex; flex-direction:column; align-items:center; position:relative;">
            <video id="preview" width="360" height="270" controls autoplay muted playsinline></video>
            <div id="countdownOverlay" aria-hidden="true"></div>

            <div class="row" style="margin-top:10px;">
                <button type="button" id="startBtn" class="alt">ë…¹í™” ì‹œì‘ (3s)</button>
                <button type="button" id="resetBtn" disabled>ì¬ì´¬ì˜</button>
            </div>
        </div>

        <button id="uploadButton" type="submit" style="margin-top:16px;">ì—…ë¡œë“œ</button>
        <div class="hint">ë¡œì»¬ì—ì„œëŠ” íŒŒì¼ì„ ì§ì ‘ ì—´ì§€ ë§ê³ , <code>http://localhost:8080</code>ì²˜ëŸ¼ <strong>HTTP ì„œë²„</strong>ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    </form>

    <div class="status-container">
        <div id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
    </div>
</div>

<script>
    // ìœ í‹¸: ì¿ í‚¤ ì¡°íšŒ
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // JWT ë””ì½”ë”© í›„ ì½˜ì†”ì— ì •ë³´ ì¶œë ¥
    function logDecodedToken(token, source) {
        try {
            const decoded = jwt_decode(token);
            console.group(`ğŸ”” JWT í† í° ë””ì½”ë”©ëœ ê°œì¸ ì •ë³´ (${source})`);
            console.log('í† í° ì¡´ì¬:', true);
            console.log('ë°œê¸‰ ì‹œê°„ (iat):', new Date(decoded.iat * 1000).toLocaleString());
            console.log('ë§Œë£Œ ì‹œê°„ (exp):', new Date(decoded.exp * 1000).toLocaleString());
            console.log('ì „ì²´ í˜ì´ë¡œë“œ:', decoded);
            console.groupEnd();
            return decoded;
        } catch (e) {
            console.warn(`JWT ë””ì½”ë”© ì‹¤íŒ¨ (${source}):`, e);
            return null;
        }
    }

    // 10ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í—¬í¼
    function redirectToSignInWithDelay(statusEl, url, seconds = 10) {
        statusEl.textContent = `ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ${seconds}ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...`;
        setTimeout(() => {
            window.location.href = url;
        }, seconds * 1000);
    }

    // ë¹„ë™ê¸° ì¸ì¦ í™•ì¸
    async function checkAuth(apiBase) {
        // 1) í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ” ì¿ í‚¤ê°€ ìˆë‹¤ë©´
        const token = getCookie('jwtAccessToken');
        if (token) {
            logDecodedToken(token, 'í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ ì²´í¬');
            return true;
        }
        // 2) httpOnly ì¿ í‚¤ ê¸°ë°˜ì¸ì§€ ì„œë²„ë¡œ í™•ì¸
        try {
            const resp = await fetch(`${apiBase}/user/me`, { method: 'GET', credentials: 'include' });
            if (resp.ok) {
                console.log('HTTP-Only ì¿ í‚¤ë¥¼ í†µí•œ ì„œë²„ ì¸ì¦ ì„±ê³µ.');
                return true;
            }
            return false;
        } catch (e) {
            console.warn('Auth check failed (Server API access error):', e);
            return false;
        }
    }

    const SIGN_IN_PAGE_URL = 'http://localhost:14000/user/sign-in.html';

    document.addEventListener('DOMContentLoaded', async () => {
        const statusDiv = document.getElementById('status');
        const preview = document.getElementById('preview');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const uploadBtn = document.getElementById('uploadButton');
        const form = document.getElementById('uploadForm');
        const countdownOverlay = document.getElementById('countdownOverlay');

        // ---- Config
        const API_GATEWAY_URL = "http://localhost:13000";
        const RECORD_SECONDS = 3;
        const COUNTDOWN_SECONDS = 3;

        // ---- State
        let mediaRecorder, recordedBlobs = [], stream, videoURL;
        let loggedIn = false;

        function enable(el, v = true) { el.disabled = !v; }
        function revokeURLSafe(url) { if (url) URL.revokeObjectURL(url); }
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // ì´ˆê¸° ì¸ì¦ í™•ì¸
        loggedIn = await checkAuth(API_GATEWAY_URL);
        console.log('ì´ˆê¸° ì¸ì¦ ìƒíƒœ:', loggedIn);
        if (loggedIn) {
            statusDiv.textContent = 'ë¡œê·¸ì¸ ìƒíƒœ: ë…¹í™” ë° ì—…ë¡œë“œ ê°€ëŠ¥';
            enable(startBtn, true);
            enable(uploadBtn, false);
            enable(resetBtn, false);
        } else {
            statusDiv.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë…¹í™”/ì—…ë¡œë“œëŠ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.';
            enable(startBtn, false);
            enable(uploadBtn, false);
            enable(resetBtn, false);
        }

        // ---- Recording with countdown and fixed duration
        startBtn.onclick = async () => {
            try {
                // ì‹œì‘ ì§ì „ ì¸ì¦ ì¬í™•ì¸
                loggedIn = await checkAuth(API_GATEWAY_URL);
                if (!loggedIn) {
                    redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                    return;
                }

                recordedBlobs = [];
                revokeURLSafe(videoURL); videoURL = null;

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
                    audio: true
                });
                preview.srcObject = stream;

                const options = { mimeType: 'video/webm; codecs=vp9,opus' };
                try { mediaRecorder = new MediaRecorder(stream, options); }
                catch { mediaRecorder = new MediaRecorder(stream); }

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) recordedBlobs.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                    videoURL = URL.createObjectURL(superBuffer);
                    preview.srcObject = null;
                    preview.src = videoURL;
                    preview.controls = true;

                    enable(resetBtn, true);
                    loggedIn = await checkAuth(API_GATEWAY_URL);
                    enable(uploadBtn, loggedIn);
                    statusDiv.textContent = loggedIn ? "ë…¹í™” ì™„ë£Œ. ì—…ë¡œë“œ ê°€ëŠ¥." : "ë…¹í™” ì™„ë£Œ. ë¡œê·¸ì¸ í•„ìš”.";
                };

                // prepare UI
                enable(startBtn, false);
                enable(uploadBtn, false);
                enable(resetBtn, false);
                countdownOverlay.style.display = 'block';

                // countdown
                for (let i = COUNTDOWN_SECONDS; i >= 1; i--) {
                    countdownOverlay.textContent = i;
                    statusDiv.textContent = `ì´¬ì˜ ì‹œì‘ê¹Œì§€: ${i}`;
                    await sleep(1000);
                }
                countdownOverlay.textContent = "";
                countdownOverlay.style.display = 'none';

                // start recording
                statusDiv.textContent = "ë…¹í™” ì¤‘...";
                mediaRecorder.start();

                // stop automatically
                setTimeout(() => {
                    try {
                        mediaRecorder?.stop();
                        stream?.getTracks()?.forEach(t => t.stop());
                        enable(startBtn, true);
                        enable(uploadBtn, loggedIn);
                    } catch (e) { console.error(e); }
                }, RECORD_SECONDS * 1000);
            } catch (err) {
                console.error(err);
                statusDiv.textContent = "ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œ í•„ìš” ë˜ëŠ” ì¥ì¹˜ ì ‘ê·¼ ì‹¤íŒ¨.";
                enable(startBtn, true);
                countdownOverlay.style.display = 'none';
            }
        };

        // reset
        resetBtn.onclick = async () => {
            try {
                recordedBlobs = [];
                preview.pause();
                preview.removeAttribute('src');
                preview.srcObject = null;
                revokeURLSafe(videoURL); videoURL = null;

                loggedIn = await checkAuth(API_GATEWAY_URL);
                enable(uploadBtn, loggedIn);
                enable(startBtn, true);
                enable(resetBtn, false);

                statusDiv.textContent = loggedIn ? "ì¬ì´¬ì˜ ì¤€ë¹„ ì™„ë£Œ." : "ì¬ì´¬ì˜ ì¤€ë¹„ ì™„ë£Œ(ë¡œê·¸ì¸ í•„ìš”).";
            } catch (e) { console.error(e); }
        };

        // ---- Upload
        form.onsubmit = async (e) => {
            e.preventDefault();

            const label = document.getElementById('motionLabel').value?.trim();
            const detectionArea = document.getElementById('detectionArea').value;

            if (!label) {
                statusDiv.textContent = "ë™ì‘ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }
            if (!videoURL || !recordedBlobs?.length) {
                statusDiv.textContent = "ë…¹í™” ì˜ìƒì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.";
                return;
            }

            // ì—…ë¡œë“œ ì „ ì¸ì¦ ì¬í™•ì¸
            loggedIn = await checkAuth(API_GATEWAY_URL);
            if (!loggedIn) {
                redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                return;
            }

            try {
                statusDiv.textContent = "ì—…ë¡œë“œ ì¤‘...";
                enable(uploadBtn, false);

                const uploadBlob = new Blob(recordedBlobs, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('motionLabel', label);
                formData.append('detectionArea', detectionArea);
                formData.append('videoFile', uploadBlob, 'motion.webm');

                const response = await fetch(`${API_GATEWAY_URL}/motions/upload`, {
                    method: 'POST',
                    credentials: 'include', // ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦
                    body: formData
                });

                if (response.ok) {
                    const result = await response.text();
                    statusDiv.textContent = `ì—…ë¡œë“œ ì„±ê³µ: ${result}`;
                } else if (response.status === 401) {
                    redirectToSignInWithDelay(statusDiv, SIGN_IN_PAGE_URL, 10);
                } else {
                    statusDiv.textContent = `ì„œë²„ ì˜¤ë¥˜: ${response.status}`;
                }
            } catch (error) {
                console.error(error);
                statusDiv.textContent = "ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. CORS/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            } finally {
                enable(uploadBtn, true);
            }
        };
    });
</script>
</body>
</html>
