<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CueCode | ë‚˜ì˜ ë™ì‘ ì‚¬ì „</title>
    <link rel="shortcut icon" type="image/png" href="../images/logos/favicon.svg" />
    <link rel="stylesheet" href="../libs/owl.carousel/dist/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="../libs/aos-master/dist/aos.css">
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/patient/patient.css" />
    <style>
        /** {*/
        /*    margin: 0;*/
        /*    padding: 0;*/
        /*    box-sizing: border-box;*/
        /*}*/

        /*body {*/
        /*    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;*/
        /*    background-color: #f5f5f5;*/
        /*    padding: 20px;*/
        /*}*/

        /*.container {*/
        /*    max-width: 1200px;*/
        /*    margin: 0 auto;*/
        /*    background: white;*/
        /*    border-radius: 10px;*/
        /*    box-shadow: 0 4px 20px rgba(0,0,0,0.1);*/
        /*    padding: 30px;*/
        /*}*/

        /*.header {*/
        /*    text-align: center;*/
        /*    margin-bottom: 30px;*/
        /*    border-bottom: 2px solid #ddd;*/
        /*    padding-bottom: 20px;*/
        /*}*/

        /*.header h1 {*/
        /*    color: #333;*/
        /*    margin-bottom: 10px;*/
        /*    font-weight: 700;*/
        /*}*/

        .user-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-input input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 200px;
            transition: border-color 0.2s;
        }

        .user-input input:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-icon {
            padding: 8px 12px;
            background: #f8d7da;
            color: #721c24;
            margin-left: 10px;
        }

        .btn-icon:hover {
            background: #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* --- Tab Styles --- */
        .tab-container {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef; /* íƒ­ ì „ì²´ ê²½ê³„ì„  ì¶”ê°€ */
        }

        .tab-buttons {
            display: flex;
            background-color: #f8f9fa; /* íƒ­ ë²„íŠ¼ ë°°ê²½ ë°ê²Œ */
            border-bottom: 1px solid #e9ecef;
            border-radius: 8px 8px 0 0;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            border: none; /* ê¸°ë³¸ í…Œë‘ë¦¬ ì œê±° */
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            text-align: center;
            background: transparent;
        }

        .tab-button.active {
            color: #007bff;
            background-color: white;
            border-bottom: 3px solid #007bff;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.05); /* í™œì„± íƒ­ì— ê·¸ë¦¼ì ì¶”ê°€ */
        }

        .tab-button:hover:not(.active) {
            background-color: #f1f3f5;
            color: #343a40;
        }

        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }
        /* --- End Tab Styles --- */

        .motion-items {
            padding: 0;
        }

        .motion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .motion-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #fff;
        }

        .motion-details {
            flex-grow: 1;
        }

        .phrase {
            font-size: 18px;
            font-weight: bold;
            color: #343a40;
            margin-bottom: 5px;
        }

        .description {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.4;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        /* .empty-state img { ìŠ¤íƒ€ì¼ ì œê±°ë¨ } */

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }

        /* ì‹œê°ì ìœ¼ë¡œ ìˆ¨ê¸°ë˜ ìŠ¤í¬ë¦°ë¦¬ë”ì— ë‚¨ê¸°ê¸° ìœ„í•œ ìœ í‹¸ í´ë˜ìŠ¤ */
        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
    </style>
</head>
<body>
<!--Header start!-->
<header class="header border-4 border-primary border-top position-fixed start-0 top-0 w-100 fixed-header">
    <div class="container">
        <div class="header-wrapper d-flex align-items-center justify-content-between">
            <div class="logo">
                <a href="/index.html" class="logo-white">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
                <a href="/index.html" class="logo-dark">
                    <img src="../images/logos/logo-dark.svg" alt="logo" class="img-fluid">
                </a>
            </div>
            <div class="d-flex align-items-center gap-4">

                <div class="btn-group">
                    <button
                            class="btn btn-secondary toggle-menu round-45 p-2 d-flex align-items-center justify-content-center bg-white rounded-circle"
                            type="button" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        <iconify-icon icon="solar:hamburger-menu-line-duotone" class="menu-icon fs-8 text-dark"></iconify-icon>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-4">
                        <div class="d-flex flex-column gap-6">
                            <div class="hstack justify-content-between border-bottom pb-6">
                                <p class="mb-0 fs-5 text-dark">Menu</p>
                                <button type="button" class="btn-close opacity-75" aria-label="Close"></button>
                            </div>
                            <div class="d-flex flex-column gap-3">
                                <ul class="header-menu list-unstyled mb-0 d-flex flex-column gap-2">
                                    <li class="header-item">
                                        <a href="index.html" aria-current="true"
                                           class="header-link active hstack gap-2 fs-7 fw-bold text-dark"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™ˆ</a>
                                    </li>
                                    <li class="header-item" id="patientMenuItem">
                                        <a href="/patient/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="patientMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">í™˜ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="managerMenuItem">
                                        <a href="../manager/dashboard.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="managerMenuLink"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
                                    </li>
                                    <li class="header-item" id="myPageMenuItem">
                                        <a href="../user/mypage.html" class="header-link hstack gap-2 fs-7 fw-bold text-dark" id="myPageMenuLinkAnchor"><img
                                                src="../images/svgs/secondary-leaf.svg" alt="" width="20" height="20"
                                                class="img-fluid animate-spin">ë§ˆì´ í˜ì´ì§€</a>
                                    </li>
                                </ul>
                                <div class="hstack gap-3" id="auth-btn-group">
                                    <a href="sign-in.html"
                                       class="btn btn-outline-light fs-6 bg-white px-3 py-2 text-dark w-50 hstack justify-content-center">ë¡œê·¸ì¸</a>
                                    <a href="sign-up.html"
                                       class="btn btn-dark text-white fs-6 bg-dark px-3 py-2 w-50 hstack justify-content-center">íšŒì›ê°€ì…</a>
                                </div>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>
<!--Header End!-->
<div class="container my-5">

    <div class="user-controls">
        <!-- ì‚¬ìš©ì ID ì…ë ¥ í•„ë“œëŠ” UIë¥¼ ìœ ì§€í•˜ë˜, ì„œë²„ í†µì‹ ì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ -->
        <div class="user-input">
            <!-- í™”ë©´ì—ì„œ ìˆ¨ê¹€: ìŠ¤í¬ë¦°ë¦¬ë”ëŠ” ì½ì„ ìˆ˜ ìˆë„ë¡ .visually-hidden í´ë˜ìŠ¤ ì‚¬ìš© -->
            <label for="userIdInput" class="visually-hidden">ì‚¬ìš©ì ID (í‘œì‹œìš©):</label>
            <input type="text" id="userIdInput" class="visually-hidden" value="" placeholder="ì‚¬ìš©ì ID" readonly>
            <!-- ğŸ“‹ ì•„ì´ì½˜ ëŒ€ì‹  ğŸ”„ ì•„ì´ì½˜ ì‚¬ìš© -->
            <button class="btn btn-primary" onclick="loadUserMotions()">ğŸ”„ ë™ì‘ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <button class="btn btn-danger" onclick="deleteAllMotions()" id="deleteBtn" disabled>
            ğŸ—‘ï¸ ëª¨ë“  ë™ì‘ ì‚­ì œ
        </button>
    </div>

    <div id="messageContainer"></div>

    <div id="statsContainer" style="display: none;">
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ì´ ë™ì‘ ê°œìˆ˜</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="typeCount">0</div>
                <div class="stat-label">ë™ì‘ ì¢…ë¥˜ ìˆ˜</div>
            </div>
        </div>
    </div>

    <div id="loadingContainer" class="loading" style="display: none;">
        <p>ğŸ”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div class="tab-container" id="motionTabContainer" style="display: none;">
        <div class="tab-buttons">
            <!-- data-type ì†ì„±ìœ¼ë¡œ íƒ€ì… í‚¤ë¥¼ ëª…ì‹œí•˜ì—¬ í…ìŠ¤íŠ¸ íŒŒì‹±ìœ¼ë¡œ ì¸í•œ 'undefined' ë¬¸ì œ í•´ê²° -->
            <button class="tab-button active" data-type="hands" onclick="openTab(event, 'Hands')">ğŸ‘‹ ì†</button>
            <button class="tab-button" data-type="eyes" onclick="openTab(event, 'Eyes')">ğŸ‘€ ëˆˆ</button>
            <button class="tab-button" data-type="face" onclick="openTab(event, 'Face')">ğŸ˜Š ì–¼êµ´</button>
        </div>

        <div class="tab-content">
            <div id="Hands" class="tab-pane active"></div>
            <div id="Eyes" class="tab-pane"></div>
            <div id="Face" class="tab-pane"></div>
        </div>
    </div>

    <div id="motionContainer" class="motion-container">
        <!-- ì´ˆê¸° Empty State ë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ -->
        <div class="empty-state">
            <h3>ì‚¬ìš©ìì˜ ëª¨ì…˜ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</h3>
        </div>
    </div>

</div>

<!--Footer Start!-->
<footer class="footer bg-dark py-5 py-lg-11 py-xl-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-5 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-8 pe-xl-5">
                    <h4 class="mb-0 text-white">ì´ í”„ë¡œì íŠ¸ëŠ” <br> ê°œë°©í˜• í´ë¼ìš°ë“œ í”Œë«í¼(K-PaaS) í™œìš©
                        <br>ê³µëª¨ì „ ì¶œí’ˆì‘ì…ë‹ˆë‹¤</h4>
                </div>
            </div>
            <div class="col-md-6 col-xl-4 mb-8 mb-xl-0">
                <div class="d-flex flex-column gap-2">
                    <a href="https://contest.k-paas.org/" target="_blank" class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:arrow-up-right" class="fs-7 text-primary"></iconify-icon>
                        https://contest.k-paas.org/
                    </a>
                    <a href="https://buly.kr/Awg81rV" target="_blank"
                       class="link-hover hstack gap-3 text-white fs-5">
                        <iconify-icon icon="lucide:map-pin" class="fs-7 text-primary"></iconify-icon>
                        ìš°ì¥ì‚° ì‚°ì‹ ë ¹ë“¤
                    </a>
                </div>
            </div>
            <div class="col-md-4 col-xl-3 mb-8 mb-xl-0">
                <p class="mb-0 text-white text-opacity-70 text-md-end">Â© CueCode copyright 2025</p>
            </div>
        </div>
    </div>
    <p class="mb-0 text-white text-opacity-70 text-md-center mt-10">Distributed by <a class="text-white"  target="_blank">Team Ujangsan Spirit</a></p>
</footer>
<!--Footer End!-->

<div class="get-template hstack gap-2">
    <button class="btn bg-primary p-2 round-52 rounded-circle hstack justify-content-center flex-shrink-0"
            id="scrollToTopBtn">
        <iconify-icon icon="lucide:arrow-up" class="fs-7 text-dark"></iconify-icon>
    </button>
</div>



<script>
    // jwt_decode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆë‹¤ê³  ê°€ì •

    // API Gateway ë° ì¸ì¦ ìœ í‹¸ ì¶”ê°€ (MSA í™˜ê²½ ëŒ€ì‘)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // ì•¡ì„¸ìŠ¤ í† í° íšë“: cookie -> localStorage -> sessionStorage ìˆœìœ¼ë¡œ í´ë°±
    function getAccessToken() {
        try {
            const cookieToken = getCookie('jwtAccessToken');
            if (cookieToken) return cookieToken;
        } catch (e) { /* ignore */ }
        try {
            const ls = localStorage.getItem('jwtAccessToken');
            if (ls) return ls;
        } catch (e) { /* ignore */ }
        try {
            const ss = sessionStorage.getItem('jwtAccessToken');
            if (ss) return ss;
        } catch (e) { /* ignore */ }

        return null;
    }

    // ì¸ì¦ëœ ì‚¬ìš©ì IDë¥¼ JWTì—ì„œ ì•ˆì „í•˜ê²Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
    function getAuthenticatedUserId() {
        const token = getAccessToken();
        if (!token) return null;
        try {
            const decoded = jwt_decode(token);
            // í”íˆ ì‚¬ìš©í•˜ëŠ” í´ë ˆì„ ìš°ì„ ìˆœìœ„: sub, userId, preferred_username, username, name, uid
            return decoded && (decoded.sub || decoded.userId || decoded.preferred_username || decoded.username || decoded.name || decoded.uid) || null;
        } catch (e) {
            console.debug('[Auth] Failed to decode token for userId extraction', e);
            return null;
        }
    }

    function logDecodedToken(token, source) {
        try {
            const decoded = jwt_decode(token);
            console.group(`ğŸ”” JWT ë””ì½”ë”© (${source})`);
            console.log('payload:', decoded);
            console.groupEnd();
            return decoded;
        } catch (e) {
            return null;
        }
    }

    function isTokenValid(token) {
        if (!token) return false;
        try {
            const decoded = jwt_decode(token);
            if (!decoded) return false;
            if (decoded.exp && (Date.now() / 1000) > decoded.exp) return false;
            return true;
        } catch (e) {
            return false;
        }
    }

    const API_GATEWAY_URL = typeof API_BASE !== 'undefined' ? API_BASE : 'http://localhost:13000';

    const API_ENDPOINTS = {
        RECORDED_MOTIONS_BASE: '/api/v1/recorded-motions',
    };

    class RecordedMotionService {
        constructor() {
            this.apiBase = API_GATEWAY_URL;
            this.currentUserId = null;
        }

        getAuthHeaders() {
            const token = getAccessToken();
            const headers = { 'Content-Type': 'application/json' };

            if (token) {
                headers['Authorization'] = 'Bearer ' + token;
                console.debug(`[Auth-Header] SET: Authorization: Bearer ${token.substring(0, 20)}...`);
            } else {
                console.debug('[Auth-Header] OMITTED: No jwtAccessToken found to set Bearer.');
            }
            return headers;
        }

        async getRecordedMotions() {
            // userIdë¥¼ URLì— í¬í•¨í•˜ì§€ ì•Šê³  ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ì— ì˜ì¡´
            const url = `${this.apiBase}${API_ENDPOINTS.RECORDED_MOTIONS_BASE}`;
            const resp = await fetch(url, {
                method: 'GET',
                headers: this.getAuthHeaders(),
                credentials: 'include'
            });

            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                const err = new Error(`${resp.status} ${resp.statusText}: ${text}`);
                err.status = resp.status;
                throw err;
            }
            return await resp.json();
        }

        async deleteRecordedMotionById(motionId) {
            // ê°œë³„ ëª¨ì…˜ ì‚­ì œ: DELETE /api/v1/recorded-motions/{motionId}
            // ë°±ì—”ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì´ ê²½ë¡œê°€ í•„ìš”í•˜ë©°, ì¸ì¦ëœ ì‚¬ìš©ì ì†Œìœ ì¸ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
            const url = `${this.apiBase}${API_ENDPOINTS.RECORDED_MOTIONS_BASE}/${encodeURIComponent(motionId)}`;
            console.debug('[API-Call] DELETE Single Motion URL:', url);

            const resp = await fetch(url, {
                method: 'DELETE',
                headers: this.getAuthHeaders(),
                credentials: 'include'
            });

            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                const err = new Error(`${resp.status} ${resp.statusText}: ${text}`);
                err.status = resp.status;
                throw err;
            }

            return await resp.text();
        }

        async deleteRecordedMotions() {
            // ëª¨ë“  ëª¨ì…˜ ì‚­ì œ (DELETE /api/v1/recorded-motions)
            const url = `${this.apiBase}${API_ENDPOINTS.RECORDED_MOTIONS_BASE}`;
            const resp = await fetch(url, {
                method: 'DELETE',
                headers: this.getAuthHeaders(),
                credentials: 'include'
            });

            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                const err = new Error(`${resp.status} ${resp.statusText}: ${text}`);
                err.status = resp.status;
                throw err;
            }

            return await resp.text();
        }
    }

    const motionService = new RecordedMotionService();

    function showMessage(message, type = 'info') {
        const container = document.getElementById('messageContainer');
        const className = type === 'error' ? 'error-message' : 'success-message';
        if (container) container.innerHTML = `<div class="${className}">${message}</div>`;
        setTimeout(() => { if (container) container.innerHTML = ''; }, 5000);
    }

    function showLoading(show) { const el = document.getElementById('loadingContainer'); if (el) el.style.display = show ? 'block' : 'none'; }
    function showTabContainer(show) { const el = document.getElementById('motionTabContainer'); if (el) el.style.display = show ? 'block' : 'none'; }


    function updateStats(motions) {
        const statsContainer = document.getElementById('statsContainer');
        const totalCount = document.getElementById('totalCount');
        const typeCount = document.getElementById('typeCount');
        if (!statsContainer || !totalCount || !typeCount) return;

        if (motions && motions.length > 0) {
            const motionTypes = new Set(motions.map(m => m.motionType));
            totalCount.textContent = motions.length;
            typeCount.textContent = motionTypes.size;
            statsContainer.style.display = 'block';
        } else {
            statsContainer.style.display = 'none';
        }
    }

    /**
     * ëª¨ì…˜ ë°ì´í„°ë¥¼ íƒ­ ì˜ì—­ì— ë§ê²Œ ë Œë”ë§í•˜ê³ , ì²« ë²ˆì§¸ íƒ­ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
     */
    function renderMotionList(motions) {
        const mainContainer = document.getElementById('motionContainer');
        const deleteBtn = document.getElementById('deleteBtn');
        const motionTypes = ['hands', 'eyes', 'face']; // í‘œì‹œí•  ìˆœì„œì™€ íƒ­ ì´ë¦„

        if (!mainContainer) return;

        if (!motions || motions.length === 0) {
            mainContainer.innerHTML = `<div class="empty-state"><h3>ğŸ“­ ë…¹í™”ëœ ëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</h3><p>í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ë“±ë¡ëœ ìˆ˜ì–´ ëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            if (deleteBtn) deleteBtn.disabled = true;
            showTabContainer(false);
            return;
        }

        if (deleteBtn) deleteBtn.disabled = false;
        showTabContainer(true);
        mainContainer.innerHTML = ''; // ê¸°ì¡´ empty-state ì œê±°

        const motionsByType = motions.reduce((acc, motion) => {
            const type = motion.motionType.toLowerCase();
            if (motionTypes.includes(type)) { // ì •ì˜ëœ íƒ­ íƒ€ì…ë§Œ ì²˜ë¦¬
                if (!acc[type]) acc[type] = [];
                acc[type].push(motion);
            }
            return acc;
        }, {});

        const motionTypeEmojis = { 'hands': 'ğŸ‘‹','face': 'ğŸ˜Š','eyes': 'ğŸ‘€' };

        // íƒ­ ë²„íŠ¼ì˜ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const tabButtons = document.querySelectorAll('.tab-buttons .tab-button');
        // í•œê¸€ ë¼ë²¨ì„ ìœ„í•œ ë§¤í•‘
        const typeLabels = { 'hands': 'ì†', 'eyes': 'ëˆˆ', 'face': 'ì–¼êµ´' };
        tabButtons.forEach(button => {
            // ìš°ì„  data-type ì†ì„±ì„ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ì¡´ í…ìŠ¤íŠ¸ íŒŒì‹±ì„ í´ë°±ë¡œ ì‚¬ìš©
            const typeKey = button.dataset.type || (button.textContent.toLowerCase().trim().split(/\s+/)[1] || 'hands');
            const count = (motionsByType[typeKey] || []).length;
            const displayLabel = typeLabels[typeKey] || (typeKey.charAt(0).toUpperCase() + typeKey.slice(1));

            // ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ì´ëª¨ì§€, ì§€ì—­í™”ëœ ë¼ë²¨, (ê°œìˆ˜) í˜•íƒœë¡œ ì¬êµ¬ì„±
            button.innerHTML = `${motionTypeEmojis[typeKey] || ''} ${displayLabel} (${count}ê°œ)`;
        });

        motionTypes.forEach(type => {
            const paneId = type.charAt(0).toUpperCase() + type.slice(1);
            const paneEl = document.getElementById(paneId);
            const typeMotions = motionsByType[type] || [];

            if (paneEl) {
                if (typeMotions.length === 0) {
                    paneEl.innerHTML = `<div class="empty-state" style="padding: 20px;">
                                            <p>${motionTypeEmojis[type]} ${paneId} ëª¨ì…˜ì€ í˜„ì¬ ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                        </div>`;
                } else {
                    paneEl.innerHTML = typeMotions.map(motion => `
                        <div class="motion-item">
                            <div class="motion-details">
                                <div class="phrase">ğŸ“ ${motion.phrase}</div>
                                <div class="description">ğŸ’¬ ${motion.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            </div>
                            ${motion.id ? `
                            <button class="btn btn-icon"
                                onclick="deleteSingleMotion('${motion.id}', '${motion.phrase}')">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                            ` : `
                            <button class="btn btn-icon" disabled title="ì‚­ì œ ë¶ˆê°€: id ì—†ìŒ">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                            `}
                        </div>
                    `).join('');
                }
            }
        });

        // ë¡œë“œ í›„ Hands íƒ­ì´ ìë™ìœ¼ë¡œ í™œì„±í™”ë˜ë„ë¡ ì„¤ì •
        const defaultTabButton = document.querySelector('.tab-button');
        if (defaultTabButton) {
            defaultTabButton.click();
        }
    }

    /**
     * íƒ­ ì „í™˜ ë¡œì§
     */
    function openTab(evt, tabName) {
        // ëª¨ë“  íƒ­ ë‚´ìš©ì„ ìˆ¨ê¹€
        const tabpanes = document.getElementsByClassName("tab-pane");
        for (let i = 0; i < tabpanes.length; i++) {
            tabpanes[i].classList.remove('active');
        }

        // ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ë¥¼ ì œê±°
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove('active');
        }

        // í˜„ì¬ ì„ íƒëœ íƒ­ ë‚´ìš©ì„ í‘œì‹œí•˜ê³  ë²„íŠ¼ì— active í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
        document.getElementById(tabName).classList.add('active');
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
        }
    }

    /**
     * ë‹¨ì¼ ëª¨ì…˜ ì‚­ì œ
     */
    async function deleteSingleMotion(motionId, motionPhrase) {
        if (!confirm(`âš ï¸ "${motionPhrase}" ëª¨ì…˜ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        showLoading(true);
        try {
            // ê°œë³„ ì‚­ì œ API í˜¸ì¶œ (ë°±ì—”ë“œì— DELETE /api/v1/recorded-motions/{motionId} êµ¬í˜„ í•„ìš”)
            const result = await motionService.deleteRecordedMotionById(motionId);
            showMessage(`âœ… ëª¨ì…˜ "${motionPhrase}"ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            setTimeout(() => { loadUserMotions(); }, 500); // 0.5ì´ˆ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
            console.error('Error deleting single motion:', error);
            const status = error && error.status ? error.status : null;
            if (status === 401) {
                showMessage('âŒ **401 Unauthorized** â€” ì¸ì¦ ì‹¤íŒ¨.', 'error');
            } else if (status === 403) {
                showMessage('âŒ **403 Forbidden** â€” ê¶Œí•œì´ ì—†ê±°ë‚˜, ë³¸ì¸ ì†Œìœ ì˜ ëª¨ì…˜ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
            } else if (status === 404) {
                showMessage('âŒ **404 Not Found** â€” ì‚­ì œí•˜ë ¤ëŠ” ëª¨ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            } else {
                showMessage(`âŒ ëª¨ì…˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`, 'error');
            }
        } finally { showLoading(false); }
    }


    async function loadUserMotions() {
        // JWTê°€ httpOnly ì¿ í‚¤ë¡œ ì €ì¥ë˜ì–´ JSì—ì„œ ì½íˆì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆìœ¼ë¯€ë¡œ,
        // ì‚¬ìš©ì IDê°€ JSì—ì„œ ì¶”ì¶œë˜ì§€ ì•Šë”ë¼ë„ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const userIdInput = document.getElementById('userIdInput');
        const extractedUserId = getAuthenticatedUserId();
        // í™”ë©´/ë¡œê¹…ì— ì‚¬ìš©í•  í‘œì‹œëª…: JSì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ” ê²½ìš° ê·¸ ê°’ì„, ì•„ë‹ˆë©´ generic label ì‚¬ìš©
        const displayUser = extractedUserId || 'ì‚¬ìš©ì';

        const token = getAccessToken();
        if (token && isTokenValid(token)) {
            // ë””ë²„ê·¸ ë¡œê·¸: í† í°ì€ ì½ì„ ìˆ˜ ìˆìŒ
            logDecodedToken(token, 'local');
        } else if (token && !isTokenValid(token)) {
            console.warn('[Auth] í† í°ì´ ì¡´ì¬í•˜ì§€ë§Œ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else {
            // í† í°ì´ JSì—ì„œ ì½íˆì§€ ì•Šì•„ë„, fetchì— credentials: 'include'ê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì„œë²„ê°€ ì¿ í‚¤ì—ì„œ ì¸ì¦ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            console.debug('[Auth] í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ” í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ì¿ í‚¤(httpOnly) ê¸°ë°˜ ì¸ì¦ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì„œë²„ì— ìš”ì²­ì„ ì§„í–‰í•©ë‹ˆë‹¤.');
        }

        showLoading(true);
        // í™”ë©´ í‘œì‹œìš© ID(ì‹¤ì œ ì‚­ì œ ë“± ì„œë²„ í˜¸ì¶œì€ ì„œë²„ì˜ ì¸ì¦ì„ ë”°ë¦„)
        motionService.currentUserId = displayUser;

        try {
            const motions = await motionService.getRecordedMotions();
            renderMotionList(motions);
            updateStats(motions);
            if (motions && motions.length > 0) showMessage(`âœ… ${displayUser}ì˜ ëª¨ì…˜ ${motions.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            else showMessage(`â„¹ï¸ ${displayUser}ì˜ ë…¹í™”ëœ ëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.`, 'info');
        } catch (error) {
            console.error('Error loading motions:', error);
            const status = error && error.status ? error.status : null;

            if (status === 401) {
                showMessage('âŒ 401 Unauthorized â€” ì¸ì¦ ì‹¤íŒ¨. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
            } else if (status === 403) {
                showMessage('âŒ 403 Forbidden â€” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            } else {
                showMessage(`âŒ ëª¨ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`, 'error');
            }
            const container = document.getElementById('motionContainer'); if (container) container.innerHTML = '';
            showTabContainer(false);
            updateStats([]);
        } finally { showLoading(false); }
    }

    async function deleteAllMotions() {
        const userId = motionService.currentUserId;
        if (!userId) { showMessage('ë¨¼ì € ëª¨ì…˜ì„ ì¡°íšŒí•´ì£¼ì„¸ìš”.', 'error'); return; }

        // confirm ëŒ€ì‹  ëª¨ë‹¬ UIë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë‚˜, ì—¬ê¸°ì„œëŠ” confirm ìœ ì§€
        if (!confirm(`âš ï¸ ì •ë§ë¡œ "${userId}" ì‚¬ìš©ìì˜ ëª¨ë“  ë…¹í™”ëœ ëª¨ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

        showLoading(true);
        try {
            const result = await motionService.deleteRecordedMotions();
            showMessage(`âœ… ${result}`, 'success');
            setTimeout(() => { loadUserMotions(); }, 1000);
        } catch (error) {
            console.error('Error deleting motions:', error);
            const status = error && error.status ? error.status : null;

            if (status === 401) {
                showMessage('âŒ **401 Unauthorized** â€” ì¸ì¦ ì‹¤íŒ¨.', 'error');
            } else if (status === 403) {
                showMessage('âŒ **403 Forbidden** â€” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            } else {
                showMessage(`âŒ ëª¨ì…˜ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`, 'error');
            }
        } finally { showLoading(false); }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ íƒ­ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
        const defaultTabButton = document.querySelector('.tab-button');
        if (defaultTabButton) defaultTabButton.click();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í°ì—ì„œ ì¸ì¦ëœ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•˜ì—¬ input(ì‹œê°ì ìœ¼ë¡œ ìˆ¨ê¹€)ì— ì±„ì›Œë„£ê³ , ì‹¤ì œ ì¡°íšŒëŠ” í•´ë‹¹ IDë¥¼ ì‚¬ìš©í•´ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        const authUserId = getAuthenticatedUserId();
        const userIdInput = document.getElementById('userIdInput');
        if (userIdInput && authUserId) userIdInput.value = authUserId;
        loadUserMotions();
    });

    const userIdInputEl = document.getElementById('userIdInput');
    if (userIdInputEl) {
        userIdInputEl.addEventListener('keypress', function(e) { if (e.key === 'Enter') loadUserMotions(); });
    }

    // loadUserMotions: ì‚¬ìš©ì IDëŠ” ìš°ì„ ì ìœ¼ë¡œ JWTì—ì„œ ì¶”ì¶œëœ ì¸ì¦ëœ IDë¥¼ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ìˆ¨ê²¨ì§„ inputì˜ ê°’ì„ í´ë°±ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    async function loadUserMotions() {
        // JWTê°€ httpOnly ì¿ í‚¤ë¡œ ì €ì¥ë˜ì–´ JSì—ì„œ ì½íˆì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆìœ¼ë¯€ë¡œ,
        // ì‚¬ìš©ì IDê°€ JSì—ì„œ ì¶”ì¶œë˜ì§€ ì•Šë”ë¼ë„ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const userIdInput = document.getElementById('userIdInput');
        const extractedUserId = getAuthenticatedUserId();
        // í™”ë©´/ë¡œê¹…ì— ì‚¬ìš©í•  í‘œì‹œëª…: JSì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ” ê²½ìš° ê·¸ ê°’ì„, ì•„ë‹ˆë©´ generic label ì‚¬ìš©
        const displayUser = extractedUserId || 'ì¸ì¦ëœ ì‚¬ìš©ì';

        const token = getAccessToken();
        if (token && isTokenValid(token)) {
            // ë””ë²„ê·¸ ë¡œê·¸: í† í°ì€ ì½ì„ ìˆ˜ ìˆìŒ
            logDecodedToken(token, 'local');
        } else if (token && !isTokenValid(token)) {
            console.warn('[Auth] í† í°ì´ ì¡´ì¬í•˜ì§€ë§Œ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else {
            // í† í°ì´ JSì—ì„œ ì½íˆì§€ ì•Šì•„ë„, fetchì— credentials: 'include'ê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì„œë²„ê°€ ì¿ í‚¤ì—ì„œ ì¸ì¦ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            console.debug('[Auth] í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ” í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ì¿ í‚¤(httpOnly) ê¸°ë°˜ ì¸ì¦ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì„œë²„ì— ìš”ì²­ì„ ì§„í–‰í•©ë‹ˆë‹¤.');
        }

        showLoading(true);
        // í™”ë©´ í‘œì‹œìš© ID(ì‹¤ì œ ì‚­ì œ ë“± ì„œë²„ í˜¸ì¶œì€ ì„œë²„ì˜ ì¸ì¦ì„ ë”°ë¦„)
        motionService.currentUserId = displayUser;

        try {
            const motions = await motionService.getRecordedMotions();
            renderMotionList(motions);
            updateStats(motions);
            if (motions && motions.length > 0) showMessage(`âœ… ${displayUser}ì˜ ëª¨ì…˜ ${motions.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            else showMessage(`â„¹ï¸ ${displayUser}ì˜ ë…¹í™”ëœ ëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.`, 'info');
        } catch (error) {
            console.error('Error loading motions:', error);
            const status = error && error.status ? error.status : null;

            if (status === 401) {
                showMessage('âŒ 401 Unauthorized â€” ì¸ì¦ ì‹¤íŒ¨. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
            } else if (status === 403) {
                showMessage('âŒ 403 Forbidden â€” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            } else {
                showMessage(`âŒ ëª¨ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`, 'error');
            }
            const container = document.getElementById('motionContainer'); if (container) container.innerHTML = '';
            showTabContainer(false);
            updateStats([]);
        } finally { showLoading(false); }
    }
</script>
<script src="../js/patient/patient.js"></script>
<script src="../libs/jquery/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/owl.carousel/dist/owl.carousel.min.js"></script>
<script src="../libs/aos-master/dist/aos.js"></script>
<script src="../js/custom.js"></script>
<script src="../js/user/index.js"></script>
<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

</html>
